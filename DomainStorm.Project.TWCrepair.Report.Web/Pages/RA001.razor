@inject IJSRuntime Js
@inject IGetService<Views.RA001, string> _ra001Service;
@inject IGetService<Stream, ReportConvertRequest> _reportService;

@using DomainStorm.Framework.Services
@using DomainStorm.Framework
@using System.Text
@using DomainStorm.Project.TWCrepair.Shared.ViewModel
@using static DomainStorm.Project.TWCrepair.Repository.CommandModel.Report.V1;
@inherits BasePage
@page "/RA001"

@if (_previewHtml != null)
{
    <StormCard Headline="檢修漏作業水壓比較表" Icon="leaderboard">
        <div slot="body">
            @(new MarkupString(_previewHtml))
        </div>
    </StormCard>
}

@code {

    [Parameter, SupplyParameterFromQuery]
    public Guid DepartmentId { get; set; }

    [Parameter, SupplyParameterFromQuery]
    public Guid? SiteId { get; set; }

    [Parameter, SupplyParameterFromQuery]
    public Guid WaterSupplySystemId { get; set; }

    [Parameter, SupplyParameterFromQuery]
    public Guid WorkSpaceId { get; set; }

    [Parameter, SupplyParameterFromQuery]
    public Guid? SmallRegionId { get; set; }

    [Parameter, SupplyParameterFromQuery]
    public DateTime BeforeDate { get; set; }

    [Parameter, SupplyParameterFromQuery]
    public DateTime AfterDate { get; set; }

    private string? _previewHtml;

    protected override async Task OnParametersSetAsync()
    {
        // GetQueryParameters(_request);

        var request = new ReportCommandModel.RA001.V1.QueryRA001
        {
            DepartmentId = DepartmentId,
            SiteId = SiteId,
            WaterSupplySystemId = WaterSupplySystemId,
            WorkSpaceId = WorkSpaceId,
            SmallRegionId = SmallRegionId,
            BeforeDate = BeforeDate,
            AfterDate = AfterDate
        };            

        var ra001 = await _ra001Service.GetAsync<ReportCommandModel.RA001.V1.QueryRA001>(request);
        var convertRequest = new ReportConvertRequest
        {
            ViewName = "/Views/RA001.cshtml",
            Model = ra001,
            Extension = FileExtension.HTML
        };

        var outStream = await _reportService.GetAsync(convertRequest);
        using var reader = new StreamReader(await _reportService.GetAsync(convertRequest), Encoding.UTF8);
        outStream.Seek(0, SeekOrigin.Begin);
        _previewHtml = await reader.ReadToEndAsync();

        await base.OnParametersSetAsync();
    }
}