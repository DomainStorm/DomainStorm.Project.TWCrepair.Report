
@using DomainStorm.Framework
@using DomainStorm.Framework.Services
@using System.Text.Json
@using DomainStorm.Framework.BlazorComponent.Extensions;
@using DomainStorm.Framework.Caching
@using DomainStorm.Project.TWCrepair.Report.Web.ReportCommandModel
@inject IJSRuntime Js
@inject IGetService<DomainStorm.Project.TWCrepair.Report.Web.Views.Dashboards.DA001, string> _da001Service;
@inject IGetService<PlotlyJson, Report.V1.ReportConvertRequest> _reportService;

@page "/DA001"

<storm-card @ref="_stormCardRef" icon="leaderboard">
    <div id="chart"></div>
</storm-card>


@code {
    private ElementReference _stormCardRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // if (levelOneDepartment == null)
        //     return;

        var request = new ReportCommandModel.DA001.V1.QueryDA001();
        var da001 = await _da001Service.GetAsync<ReportCommandModel.DA001.V1.QueryDA001>(request);
        var convertRequest = new Report.V1.ReportConvertRequest
        {
            ViewName = "/Views/Dashboards/DA001.cshtml",
            Model = da001,
            Extension = IConvert.Extension.JSON
        };

        var plotlyJson = await _reportService.GetAsync(convertRequest);
        await Js.SetProperty(_stormCardRef, "headline", plotlyJson.Layout.Title);
        plotlyJson.Layout.Title = "";
        plotlyJson.Layout.Margin.T = 0;
        await Js.InvokeVoidAsync("drawChart", "chart", JsonSerializer.Serialize(plotlyJson, new JsonSerializerOptions(JsonSerializerDefaults.Web)));
    }
}
