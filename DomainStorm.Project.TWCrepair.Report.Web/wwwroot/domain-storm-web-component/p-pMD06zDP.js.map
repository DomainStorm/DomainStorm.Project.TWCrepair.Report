{"version":3,"file":"p-pMD06zDP.js","sources":["src/utils/cache/cache-service.ts"],"sourcesContent":["import type { CacheEntry, CacheOptions, CacheProvider } from './interface';\r\n\r\nconst DEFAULT_TTL_MS = 600_000;\r\n\r\nexport { CacheEntry, CacheOptions, CacheProvider };\r\n\r\nexport class CacheService {\r\n    private readonly provider: CacheProvider;\r\n    private readonly keyPrefix: string;\r\n    private readonly defaultTtlMs: number;\r\n\r\n    constructor(provider: CacheProvider, options: CacheOptions = {}) {\r\n        this.provider = provider;\r\n        this.keyPrefix = options.regionName ?? provider.defaultKeyPrefix ?? 'cache';\r\n        this.defaultTtlMs = options.ttlMillis ?? DEFAULT_TTL_MS;\r\n\r\n        if (options.maxEntries && provider.setMaxEntries) {\r\n            provider.setMaxEntries(options.maxEntries);\r\n        }\r\n    }\r\n\r\n    private getFullKey(key: string): string {\r\n        return this.keyPrefix + ':' + key;\r\n    }\r\n\r\n    private isExpired(entry: CacheEntry): boolean {\r\n        const ttl = (typeof entry.ttlMillis === 'number' && !isNaN(entry.ttlMillis)) \r\n            ? entry.ttlMillis \r\n            : this.defaultTtlMs;\r\n        return (Date.now() - entry.timestamp) > ttl;\r\n    }\r\n\r\n    async get<T = any>(key: string): Promise<T | null> {\r\n        const fullKey = this.getFullKey(key);\r\n        const entry = await this.provider.get(fullKey);\r\n\r\n        if (!entry) return null;\r\n        \r\n        if (this.isExpired(entry)) {\r\n            // Fire and forget deletion for expired entries\r\n            this.provider.delete(fullKey).catch(() => {});\r\n            return null;\r\n        }\r\n\r\n        return entry.value as T;\r\n    }\r\n\r\n    async set(key: string, value: any, ttlMs = this.defaultTtlMs): Promise<void> {\r\n        const fullKey = this.getFullKey(key);\r\n        const entry: CacheEntry = {\r\n            value,\r\n            timestamp: Date.now(),\r\n            ttlMillis: ttlMs,\r\n        };\r\n        \r\n        await this.provider.set(fullKey, entry);\r\n    }\r\n\r\n    async delete(key: string): Promise<void> {\r\n        const fullKey = this.getFullKey(key);\r\n        await this.provider.delete(fullKey);\r\n    }\r\n\r\n    async clear(): Promise<void> {\r\n        await this.provider.clear();\r\n    }\r\n\r\n    async size(): Promise<number> {\r\n        return await this.provider.size();\r\n    }\r\n\r\n    async destroy(): Promise<void> {\r\n        if (this.provider.destroy) {\r\n            await this.provider.destroy();\r\n        } else {\r\n            await this.provider.clear();\r\n        }\r\n    }\r\n}"],"names":[],"mappings":"AAEA,MAAM,cAAc,GAAG,OAAO;MAIjB,YAAY,CAAA;AACJ,IAAA,QAAQ;AACR,IAAA,SAAS;AACT,IAAA,YAAY;IAE7B,WAAY,CAAA,QAAuB,EAAE,OAAA,GAAwB,EAAE,EAAA;AAC3D,QAAA,IAAI,CAAC,QAAQ,GAAG,QAAQ;AACxB,QAAA,IAAI,CAAC,SAAS,GAAG,OAAO,CAAC,UAAU,IAAI,QAAQ,CAAC,gBAAgB,IAAI,OAAO;QAC3E,IAAI,CAAC,YAAY,GAAG,OAAO,CAAC,SAAS,IAAI,cAAc;QAEvD,IAAI,OAAO,CAAC,UAAU,IAAI,QAAQ,CAAC,aAAa,EAAE;AAC9C,YAAA,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,UAAU,CAAC;;;AAI1C,IAAA,UAAU,CAAC,GAAW,EAAA;AAC1B,QAAA,OAAO,IAAI,CAAC,SAAS,GAAG,GAAG,GAAG,GAAG;;AAG7B,IAAA,SAAS,CAAC,KAAiB,EAAA;AAC/B,QAAA,MAAM,GAAG,GAAG,CAAC,OAAO,KAAK,CAAC,SAAS,KAAK,QAAQ,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,SAAS,CAAC;cACrE,KAAK,CAAC;AACR,cAAE,IAAI,CAAC,YAAY;AACvB,QAAA,OAAO,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,KAAK,CAAC,SAAS,IAAI,GAAG;;IAG/C,MAAM,GAAG,CAAU,GAAW,EAAA;QAC1B,MAAM,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC;QACpC,MAAM,KAAK,GAAG,MAAM,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,CAAC;AAE9C,QAAA,IAAI,CAAC,KAAK;AAAE,YAAA,OAAO,IAAI;AAEvB,QAAA,IAAI,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,EAAE;;AAEvB,YAAA,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,KAAK,CAAC,MAAO,GAAC,CAAC;AAC7C,YAAA,OAAO,IAAI;;QAGf,OAAO,KAAK,CAAC,KAAU;;IAG3B,MAAM,GAAG,CAAC,GAAW,EAAE,KAAU,EAAE,KAAK,GAAG,IAAI,CAAC,YAAY,EAAA;QACxD,MAAM,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC;AACpC,QAAA,MAAM,KAAK,GAAe;YACtB,KAAK;AACL,YAAA,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;AACrB,YAAA,SAAS,EAAE,KAAK;SACnB;QAED,MAAM,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,EAAE,KAAK,CAAC;;IAG3C,MAAM,MAAM,CAAC,GAAW,EAAA;QACpB,MAAM,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,GAAG,CAAC;QACpC,MAAM,IAAI,CAAC,QAAQ,CAAC,MAAM,CAAC,OAAO,CAAC;;AAGvC,IAAA,MAAM,KAAK,GAAA;AACP,QAAA,MAAM,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE;;AAG/B,IAAA,MAAM,IAAI,GAAA;AACN,QAAA,OAAO,MAAM,IAAI,CAAC,QAAQ,CAAC,IAAI,EAAE;;AAGrC,IAAA,MAAM,OAAO,GAAA;AACT,QAAA,IAAI,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE;AACvB,YAAA,MAAM,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE;;aAC1B;AACH,YAAA,MAAM,IAAI,CAAC,QAAQ,CAAC,KAAK,EAAE;;;AAGtC;;;;"}