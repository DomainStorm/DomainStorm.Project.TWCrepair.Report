import{r as t,c as e,h as i,H as s,a as h,f as n}from"./p-BrLtLH4U.js";import{d as a,a as r,s as l,h as o,j as c,k as d,e as u,l as f,r as p,b}from"./p-D2THwjm1.js";import{C as m}from"./p-pMD06zDP.js";import{c as g}from"./p-B4NwC13r.js";import{d as y,h as C}from"./p-9Du3dL5x.js";import"./p-E-ZsRS8r.js";const w=":host{display:block}";const x=class{constructor(i){t(this,i);this.valueChanged=e(this,"valueChanged")}_dataSet;type="checkbox";labelClasses="custom-control-label";isSwitch=false;isInline=false;dataSet;value;disabled;valueChanged;dataSetWatcher(t){try{this._dataSet=typeof t==="string"?JSON.parse(t):t}catch(t){console.error("Invalid JSON format:",t);return}if(this.value){this.valueWatcher(this.value)}else this.value=this.type==="checkbox"?this._dataSet.find((t=>t.checked))?.id:this._dataSet.filter((t=>t.checked)).map((t=>t.id));if(this.type==="radio"){const t=this._dataSet.filter((t=>t.checked));if(t.length===0){this._dataSet[0].checked=true}else if(t.length>1){t.reverse().slice(1).forEach((t=>t.checked=false))}}}valueWatcher(t){if(Array.isArray(t))this._dataSet.forEach((e=>e.checked=t.includes(e.id)));else this._dataSet.forEach((e=>e.checked=e.id==t))}check(t){if(this.type==="radio"){this.uncheckAll()}t.checked=true;if(this.type==="radio"){this.value=t.id}else if(Array.isArray(this.value)){if(!this.value.includes(t.id))this.value=[...this.value,t.id]}else{this.value=[t.id]}}uncheck(t){t.checked=false;if(this.type==="radio"){if(this.value===t.id){this.value=null}}else if(Array.isArray(this.value)){this.value=this.value.filter((e=>e!==t.id))}}uncheckAll(){if(this._dataSet){this._dataSet.filter((t=>t.checked)).forEach((t=>t.checked=false))}}componentWillLoad(){if(this.dataSet){this.dataSetWatcher(this.dataSet)}}dataSetRender(){return this._dataSet.map((t=>{if(!t.id)t.id=t.label;return i("storm-checkbox",{type:this.type,label:t.label,labelClasses:t.labelClasses??this.labelClasses,isDisabled:this.disabled||t.disabled,isChecked:t.checked,isSwitch:this.isSwitch,isInline:this.isInline,onValueChanged:e=>{if(e.detail){this.check(t)}else{this.uncheck(t)}}})}))}render(){return i(s,{key:"b790a9c4d4140b30db3ffab01edd442aa88835e1"},this.dataSetRender())}static get watchers(){return{dataSet:["dataSetWatcher"],value:["valueWatcher"]}}};x.style=w;const v=":host{display:block}";const k=class{constructor(i){t(this,i);this.valueChanged=e(this,"valueChanged");this.textChanged=e(this,"textChanged");this.searchChanged=e(this,"searchChanged")}_dropdownRef;_treeRef;_text;get host(){return h(this)}label;heading;text;value;dataSet;dataSource;disabled;nullable=false;fieldId="id";fieldLabel="label";fieldChildren="children";expandLevel=2;nodeSelectableRule;size="Default";partialLoad=false;loading="lazy";class;valid;required;searchText;searchable=false;selection="single";timeStamp;valueChanged;textChanged;searchChanged;valueWatcher(t,e){if(a(t,e))return;this.updateValue();this.valueChanged.emit(this.value)}textWatcher(){this.textChanged.emit(this.text)}dataSetWatcher(){this._treeRef.dataSet=this.dataSet}updateValue(){if(this._treeRef.value!=this.value)this._treeRef.value=this.value;if(this._dropdownRef.value!=this.value)this._dropdownRef.value=this.value}componentDidLoad(){this.updateValue()}renderTree(){return i("storm-tree-view",{ref:t=>this._treeRef=t,partialLoad:this.partialLoad,loading:this.loading,value:this.value,class:this.class,dataSet:this.dataSet,dataSource:this.dataSource,fieldId:this.fieldId,fieldLabel:this.fieldLabel,fieldChildren:this.fieldChildren,nullable:this.nullable,selection:this.selection,expandLevel:this.expandLevel,nodeSelectableRule:this.nodeSelectableRule,searchable:this.searchable,onValueChanged:t=>{t.stopPropagation();this.value=t.detail},onNodeClick:async t=>{t.stopPropagation();await this._dropdownRef.hide()},onSearchChanged:t=>{t.stopPropagation();this.searchChanged.emit(t.detail)}})}async componentWillRender(){this._text=this.text;if(this._text==null){if(this._treeRef&&this.value){const t=Array.isArray(this.value)?this.value:[this.value];const e=[];for(const i of t){const t=await this._treeRef.getNodeById(i);if(t){e.push(await this._treeRef.getLabel(t))}}this._text=e.join("、")}else{this._text=undefined}}}render(){return i(s,{key:"9ad18fdf8c17d1a6131da863ee783bca2cdbbf8e"},i("storm-dropdown",{key:"fe24118fce97612bd5a8c894c76221477ad03367",ref:t=>this._dropdownRef=t,nullable:this.nullable,heading:this.heading,label:this.label,text:this._text,value:this.value,showSelected:true,valid:this.valid,required:this.required,disabled:this.disabled,timeStamp:this.timeStamp,type:"select",onValueChanged:t=>{t.stopPropagation();this.value=t.detail;if(this.value==null){this.text=undefined}},onUnselectedAll:async t=>{t.stopPropagation();await this._treeRef.unselectAll()},onShowMenu:async t=>{t.stopPropagation();await this._treeRef.loadDataSet();if(this.searchable&&this._treeRef){requestAnimationFrame((async()=>{await this._treeRef.setSearchFocus()}))}}},this.renderTree()))}static get watchers(){return{value:["valueWatcher"],text:["textWatcher"],dataSet:["dataSetWatcher"]}}};k.style=v;function S(t){if(typeof t!=="string")return false;return typeof t==="string"&&/^@[a-zA-Z0-9:-]+\('.*'\)$/.test(t.trim())}function V(t){const e=t.trim();const i=/^@([a-zA-Z0-9:-]+)\('([^']*)'\)$/;const s=i.exec(e);if(!s)return null;return{command:s[1],value:s[2]}}class A{store=new Map;maxEntries;constructor(t=1e3){this.maxEntries=t}async get(t){return this.store.get(t)||null}async set(t,e){if(!this.store.has(t)&&this.store.size>=this.maxEntries){this.evictOldestEntry()}this.store.set(t,e)}evictOldestEntry(){const t=this.store.keys();const e=t.next().value;if(e!==undefined){this.store.delete(e)}}async delete(t){this.store.delete(t)}async clear(){this.store.clear()}get defaultKeyPrefix(){return"mem"}async size(){return this.store.size}setMaxEntries(t){this.maxEntries=t;this.enforceMaxEntries()}enforceMaxEntries(){const t=this.store.size-this.maxEntries;if(t<=0)return;const e=this.store.keys();for(let i=0;i<t;i++){const t=e.next().value;if(t===undefined)break;this.store.delete(t)}}getMaxEntries(){return this.maxEntries}async destroy(){this.store.clear()}}const D=new m(new A);async function _(t,e=[],i={}){if(typeof t!=="string"){throw new TypeError("methodName 必須是字串")}i={cache:true,regionName:"dotnetInterop",...i};const s=`${t}:${JSON.stringify(e)}`;const h=i.cache??true;if(h){const t=await D.get(s);if(t!==null){return t}}try{const i=await(window.counterInterop?.invokeMethodAsync(t,...e));if(h){await D.set(s,i)}return i}catch(e){console.error(`[Interop] 無法呼叫 '${t}'：`,e);return"unknown"}}const W=":host{display:block}.input-group.input-group-static .form-control{background-color:white;line-height:1.25rem;padding:0.25rem}.detail-button{cursor:pointer}";const L=class{constructor(i){t(this,i);this.clickCell=e(this,"clickCell");this.clickAction=e(this,"clickAction");this.valueChanged=e(this,"valueChanged");this.cellWillValueChanged=e(this,"cellWillValueChanged");this.cellValueChanged=e(this,"cellValueChanged");this.cellDidValueChanged=e(this,"cellDidValueChanged");this.cellValueChangedOnBlur=e(this,"cellValueChangedOnBlur")}__cellValueEditingEvent;get host(){return h(this)}cellData;cellType="text";isDisabled=false;prependText;appendText;table;row;index;column;timeStamp;clickCell;clickAction;valueChanged;cellWillValueChanged;cellValueChanged;cellDidValueChanged;cellValueChangedOnBlur;valueChangedHandler(t){if(!this.column?.field)return;const e={id:r(this.row,this.table.fieldId),field:this.column.field,value:t.detail};this.cellWillValueChanged.emit(e)}cellWillValueChangedHandler(t){if(this.table.sidePagination==="stencil"){this.cellValueChanged.emit(t.detail)}}cellValueChangedHandler(t){l(this.row,this.column.field,t.detail.value);if(this.table.sidePagination==="stencil"){this.cellDidValueChanged.emit(t.detail)}}cellDidValueChangedHandler(t){if(this.host.querySelector(":focus")){this.__cellValueEditingEvent=t.detail}else if(this.__cellValueEditingEvent!=null){this.__cellValueEditingEvent=t.detail;this.__emitCellValueChangedOnBlur()}this.rerender()}focusoutHandler(t){if(this.__cellValueEditingEvent){this.__emitCellValueChangedOnBlur()}}rerender=y((()=>{n(this)}),100);async dispatchCustomEvent(t,e){this[t].emit(e)}renderSerialNumber(){return(this.table.pageNumber-1)*this.table.pageSize+this.index+1}renderDetail(){return i(g,{onToggle:t=>{const e=this.table.host.shadowRoot.querySelector('.row-detail[data-index="'+this.index+'"]');if(e){e.classList.toggle("d-none",!t)}}})}renderActionControl(){return i("storm-table-toolbar",{table:this.table,column:this.column,row:this.row,timeStamp:this.timeStamp,onClickAction:t=>{t.stopPropagation();this.clickAction.emit(t.detail)}})}renderInputControl(){return i("div",{class:"input-group input-group-static"},i("input",{class:"form-control",type:"text","aria-label":this.column.title,disabled:this.isDisabled,value:r(this.row,this.column.field),onClick:t=>t.stopPropagation(),onChange:t=>{t.stopPropagation();this.valueChanged.emit(t.target.value)}}))}renderTextareaControl(){const t=this.cellData;return i("div",{class:"input-group input-group-static"},i("textarea",{class:"form-control",disabled:this.isDisabled,cols:t.cols,rows:t.rows,title:this.column.title,value:r(this.row,this.column.field),onClick:t=>t.stopPropagation(),onChange:t=>{t.stopPropagation();this.valueChanged.emit(t.target.value)}}))}renderDropdownControl(){const t=this.cellData;const e=t.dataSet;return i("storm-dropdown",{disabled:this.isDisabled,label:t.label,value:r(this.row,this.column.field),dataSet:e,nullable:t.nullable??false,searchable:t.searchable??true,selection:"single",timeStamp:this.timeStamp,type:"select",onValueChanged:t=>{t.stopPropagation();this.valueChanged.emit(t.detail)}})}renderDropdownTreeControl(){const t=this.cellData;let e=t.dataSet;if(t.dataSets&&o(t.dataSets)){const i=t.dataSets.find((t=>c(t.conditions)&&d(t.conditions,this.row)));if(i){e=i.value}}return i("storm-dropdown-tree",{disabled:this.isDisabled,loading:t.loading,partialLoad:t.partialLoad,label:t.label,value:r(this.row,this.column.field),text:t.fieldText?r(this.row,t.fieldText):null,dataSet:e,dataSource:t.dataSource,fieldId:t.fieldId??"id",fieldLabel:t.fieldLabel??"label",fieldChildren:t.fieldChildren??"children",expandLevel:t.expandLevel??2,nodeSelectableRule:t.nodeSelectableRule,nullable:t.nullable??false,searchable:t.searchable??true,selection:"single",timeStamp:this.timeStamp,onValueChanged:t=>{t.stopPropagation();this.valueChanged.emit(t.detail)},onTextChanged:e=>{e.stopPropagation();if(t.fieldText)l(this.row,t.fieldText,e.detail)},onSearchChanged:t=>{t.stopPropagation()}})}renderCheckControl(){return i("storm-checkbox",{type:this.cellType==="checkbox"?"checkbox":"radio","is-disabled":this.isDisabled,"is-checked":r(this.row,this.column.field),"time-stamp":this.timeStamp})}renderCheckboxGroupControl(){const t=this.cellData;const e=r(this.row,this.column.field);const s=t.dataSet.filter((t=>{if(t.visible===undefined)return true;return typeof t.visible==="function"?t.visible(this.row):t.visible})).map((t=>({id:t.id,label:t.label,labelClasses:t.labelClasses,checked:t.checked,disabled:t.disabled})));return i("div",{class:"input-group input-group-static"},i("storm-checkbox-group",{disabled:this.isDisabled,type:t.groupType,value:e,dataSet:s,isSwitch:t.isSwitch??false,isInline:t.isInline??true,onValueChanged:t=>{t.stopPropagation();this.valueChanged.emit(t.detail)}}))}renderCellContent(){switch(this.cellType){case"action":return this.renderActionControl();case"input":return this.renderInputControl();case"checkbox":case"radio":return this.renderCheckControl();case"textarea":return this.renderTextareaControl();case"dropdown":return this.renderDropdownControl();case"dropdownTree":return this.renderDropdownTreeControl();case"checkboxGroup":return this.renderCheckboxGroupControl();case"serialNumber":return this.renderSerialNumber();case"detail":return this.renderDetail();case"text":return this.renderCellValue();case"empty":return"";default:return null}}renderCell(){if(!this.prependText&&!this.appendText){return this.renderCellContent()}else{return i("div",{class:"d-flex flex-row gap-1 align-items-center"},this.prependText&&i("span",null,this.prependText),this.renderCellContent(),this.appendText&&i("span",null,this.appendText))}}renderCellValue(){let t=r(this.row,this.column.field);if(typeof this.column.render==="function"){t=this.column.render(t,this.row,this.index)}else{if(Array.isArray(t)){t=t.filter((t=>t!=null&&t!=="")).join("、")}if(this.table.escape&&typeof t!=="boolean"&&t!=null){t=C.encode(String(t))}if(t!=null&&this.column.transform&&this.column.transform[t.toString()]){t=this.column.transform[t]}else if(t&&this.table.searchable&&this.table.searchText){t=u(t,this.table.searchText)}}const e=this.column.cellTemplate||this.table.cellTemplate;const s=t!=null&&t.toString().trim().length>0?t:"-";return i("span",{innerHTML:f(e,{value:s,row:this.row,index:this.index})})}async componentWillRender(){if(!this.column){this.resetCellState();return}const[t,e]=await Promise.all([this.resolvePropertyValueAsync(this.column,"cellType"),this.resolvePropertyValueAsync(this.column,"data")]);this.cellType=t||this.column.type||"text";this.cellData=e;if(!this.cellData||typeof this.cellData!=="object"||Array.isArray(this.cellData)){this.resetControlState();return}const[i,s,h]=await Promise.all([this.resolvePropertyValueAsync(this.cellData,"disabled"),this.resolvePropertyValueAsync(this.cellData,"prependText"),this.resolvePropertyValueAsync(this.cellData,"appendText")]);this.isDisabled=i??false;this.prependText=s;this.appendText=h;if(this.isDisabled&&(this.cellType==="input"||this.cellType==="textarea")){this.cellType="text"}}resetCellState(){this.cellType="text";this.cellData=undefined;this.resetControlState()}resetControlState(){this.isDisabled=false;this.prependText=undefined;this.appendText=undefined;this.__cellValueEditingEvent=undefined}async resolvePropertyValueAsync(t,e){const i=p(t,e,[this.row,this.index,this.column]);if(S(i)){return this.handleCommandString(i)}if(c(i)){return d(i,this.row)}if(o(i)){return this.evaluateConditionGroups(i)}if(i instanceof Promise){try{return await i}catch(t){console.error("屬性 Promise 解析失敗",t);throw t}}return i}async handleCommandString(t){const e=V(t);if(e.command==="Invoke:DotNet"){const t=r(this.row,this.table?.fieldId);try{return await _(e.value,[t,this.index,this.column.field],{cache:true})}catch(t){console.error("InvokeDotNetMethod 執行失敗",t);throw t}}if(e.command==="Get:Field"){return r(this.row,e.value)}return t}evaluateConditionGroups(t){for(const e of t){if(c(e.conditions)&&d(e.conditions,this.row)){return e.value}}return undefined}__emitCellValueChangedOnBlur=y((()=>{if(this.__cellValueEditingEvent!==undefined){this.cellValueChangedOnBlur.emit(this.__cellValueEditingEvent);this.__cellValueEditingEvent=undefined}}),500);render(){return i(s,{key:"e3a51d60efc6e955105279db57989762f56555bd",onClick:t=>{if(this.cellType==="checkbox"||this.cellType==="radio"){t.stopPropagation();t.preventDefault();const e=this.cellData;if(e&&e.disabled){return}}this.clickCell.emit({id:r(this.row,this.table.fieldId),field:this.column.field})}},this.renderCell())}};L.style=W;const T=":host{display:block}:host storm-button,:host storm-dropdown,:host div{vertical-align:middle}:host .btn:hover:not(.active){color:white}:host .btn.btn-outline-primary:hover{background-color:#e91e63}:host .btn.disabled{color:#7b809a;border-color:#7b809a;cursor:not-allowed}";const I=class{constructor(i){t(this,i);this.clickAction=e(this,"clickAction")}__dateSet;get host(){return h(this)}table;column;row;isDynamicLabel=true;timeStamp;clickAction;componentWillRender(){this.__dateSet=this.column.buttons?.map((t=>{const e={id:t.id,type:t.type,label:t.label,tooltip:t.tooltip,icon:t.icon,size:"sm",buttonStyle:"outline-primary",rounded:true,visible:()=>{if(c(t.visible)){return d(t.visible,this.row)}return b(this,t.visible,this.row,this.table,r(this.row,this.table.fieldIndex))??true},disabled:()=>{if(c(t.disabled)){return d(t.disabled,this.row)}return b(this,t.disabled,this.row,this.table,r(this.row,this.table.fieldIndex))??false},items:t.items?t.items.map((t=>({id:t.id,title:t.title,icon:t.icon,selected:t.selected,visible:()=>{if(c(t.visible)){return d(t.visible,this.row)}return b(this,t.visible,this.row,this.table,r(this.row,this.table.fieldIndex))??true},disabled:()=>{if(c(t.disabled)){return d(t.disabled,this.row)}return b(this,t.disabled,this.row,this.table,r(this.row,this.table.fieldIndex))??false}}))):null,click:(e,i=null)=>{if(t.action)t.action(this.row,t,this.table,i);this.clickAction.emit({id:r(this.row,this.table.fieldId),field:this.column.field,actionId:t.id,dropdownItemId:i?i.id:null})}};return e}))}render(){return i(s,{key:"bb5b59f7d7045d641e945e7caa9d5829baeceb99"},i("storm-toolbar",{key:"5bf34fd9adb8d6daccd825ffc08917602482c6d2",class:{"storm-dynamic-label":this.isDynamicLabel,"justify-content-start":this.column.align==="left","justify-content-center":this.column.align==="center","justify-content-end":this.column.align==="right"},dataSet:this.__dateSet,timeStamp:this.timeStamp}))}};I.style=T;export{x as storm_checkbox_group,k as storm_dropdown_tree,L as storm_table_cell,I as storm_table_toolbar};
//# sourceMappingURL=p-dc2a2d97.entry.js.map