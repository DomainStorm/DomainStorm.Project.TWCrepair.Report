import{r as t,c as e,h as i,H as s,a as h,f as a}from"./p-CQNG65Br.js";import{d as n,c as l,a as r,s as o,o as c,j as d,k as u,l as p,f as b,n as m,r as f,e as g}from"./p-CH__wnBt.js";import{C}from"./p-pMD06zDP.js";import{c as y}from"./p-tR-hyYiS.js";import{D as v,I as w}from"./p-Ck_EVl-G.js";import{d as x,h as S}from"./p-9Du3dL5x.js";import"./p-E-ZsRS8r.js";const k=class{constructor(i){t(this,i),this.valueChanged=e(this,"valueChanged")}_dataSet;type="checkbox";labelClasses="custom-control-label";isSwitch=!1;isInline=!1;dataSet;value;disabled;valueChanged;dataSetWatcher(t){try{this._dataSet="string"==typeof t?JSON.parse(t):t}catch(t){return void console.error("Invalid JSON format:",t)}if(this.value?this.valueWatcher(this.value):this.value="radio"===this.type?this._dataSet.find((t=>t.checked))?.id:this._dataSet.filter((t=>t.checked)).map((t=>t.id)),"radio"===this.type){const t=this._dataSet.filter((t=>t.checked));0===t.length?this._dataSet[0].checked=!0:t.length>1&&t.reverse().slice(1).forEach((t=>t.checked=!1))}}valueWatcher(t){Array.isArray(t)?this._dataSet.forEach((e=>e.checked=t.includes(e.id))):this._dataSet.forEach((e=>e.checked=e.id==t))}check(t){"radio"===this.type&&this.uncheckAll(),t.checked=!0,"radio"===this.type?this.value=t.id:Array.isArray(this.value)?this.value.includes(t.id)||(this.value=[...this.value,t.id]):this.value=[t.id],this.valueChanged.emit(this.value)}uncheck(t){t.checked=!1,"radio"===this.type?this.value===t.id&&(this.value=null):Array.isArray(this.value)&&(this.value=this.value.filter((e=>e!==t.id))),this.valueChanged.emit(this.value)}uncheckAll(){this._dataSet&&this._dataSet.filter((t=>t.checked)).forEach((t=>t.checked=!1))}componentWillLoad(){this.dataSet&&this.dataSetWatcher(this.dataSet)}dataSetRender(){return this._dataSet?.map((t=>(t.id||(t.id=t.label),i("storm-checkbox",{type:this.type,label:t.label,labelClasses:t.labelClasses??this.labelClasses,isDisabled:this.disabled||t.disabled,isChecked:t.checked,isSwitch:this.isSwitch,isInline:this.isInline,onValueChanged:e=>{e.detail?this.check(t):this.uncheck(t)}}))))}render(){return i(s,{key:"77999d8a4efad07dcfbc6e936c3df76e4d89cfbc"},this.dataSetRender())}static get watchers(){return{dataSet:[{dataSetWatcher:0}],value:[{valueWatcher:0}]}}};k.style=":host{display:block}";const V=class{constructor(i){t(this,i),this.valueChanged=e(this,"valueChanged"),this.textChanged=e(this,"textChanged"),this.searchChanged=e(this,"searchChanged")}_dropdownRef;_treeRef;_text;label;heading;text;value;dataSet;dataSource;disabled;nullable=!1;fieldId="id";fieldLabel="label";fieldChildren="children";expandLevel=2;nodeSelectableRule;size="Default";partialLoad=!1;loading="lazy";class;valid;required;searchText;searchable=!1;selection="single";timeStamp;valueChanged;textChanged;searchChanged;valueWatcher(t,e){n(t,e)||(this.updateValue(),this.valueChanged.emit(this.value))}textWatcher(){this.textChanged.emit(this.text)}dataSetWatcher(){this._treeRef&&(this._treeRef.dataSet=this.dataSet)}updateValue(){this._treeRef&&this._treeRef.value!=this.value&&(this._treeRef.value=this.value),this._dropdownRef&&this._dropdownRef.value!=this.value&&(this._dropdownRef.value=this.value)}componentDidLoad(){this.updateValue()}renderTree(){return i("storm-tree-view",{ref:t=>this._treeRef=t,partialLoad:this.partialLoad,loading:this.loading,value:this.value,class:this.class,dataSet:this.dataSet,dataSource:this.dataSource,fieldId:this.fieldId,fieldLabel:this.fieldLabel,fieldChildren:this.fieldChildren,nullable:this.nullable,selection:this.selection,expandLevel:this.expandLevel,nodeSelectableRule:this.nodeSelectableRule,searchable:this.searchable,onValueChanged:t=>{t.stopPropagation(),this.value=t.detail},onNodeClick:async t=>{t.stopPropagation(),await this._dropdownRef.hide()},onSearchChanged:t=>{t.stopPropagation(),this.searchChanged.emit(t.detail)}})}async componentWillRender(){if(this._text=this.text,null==this._text)if(this._treeRef&&this.value){const t=Array.isArray(this.value)?this.value:[this.value],e=[];for(const i of t){const t=await this._treeRef.getNodeById(i);t&&e.push(await this._treeRef.getLabel(t))}this._text=e.join("、")}else this._text=void 0}render(){return i(s,{key:"deb1aa982fdac56bc05ece134a816a7e9791a903"},i("storm-dropdown",{key:"da2240579fa5608bf93eb3f04e3f19d35ccc982f",ref:t=>this._dropdownRef=t,nullable:this.nullable,heading:this.heading,label:this.label,text:this._text,value:this.value,showSelected:!0,valid:this.valid,required:this.required,disabled:this.disabled,timeStamp:this.timeStamp,type:"select",onValueChanged:t=>{t.stopPropagation(),this.value=t.detail,null==this.value&&(this.text=void 0)},onUnselectedAll:async t=>{t.stopPropagation(),await this._treeRef.unselectAll()},onShowMenu:async t=>{t.stopPropagation(),await this._treeRef.loadDataSet(),this.searchable&&this._treeRef&&requestAnimationFrame((async()=>{await this._treeRef.setSearchFocus()}))}},this.renderTree()))}static get watchers(){return{value:[{valueWatcher:0}],text:[{textWatcher:0}],dataSet:[{dataSetWatcher:0}]}}};V.style=":host{display:block}";const _=new C(new class{store=new Map;maxEntries;constructor(t=1e3){this.maxEntries=Math.max(1,t)}async get(t){return this.store.get(t)||null}async set(t,e){!this.store.has(t)&&this.store.size>=this.maxEntries&&this.evictOldestEntry(),this.store.set(t,e)}evictOldestEntry(){const t=this.store.keys().next().value;void 0!==t&&this.store.delete(t)}async delete(t){this.store.delete(t)}async clear(){this.store.clear()}get defaultKeyPrefix(){return"mem"}async size(){return this.store.size}setMaxEntries(t){this.maxEntries=Math.max(1,t),this.enforceMaxEntries()}enforceMaxEntries(){const t=this.store.size-this.maxEntries;if(t<=0)return;const e=this.store.keys();for(let i=0;i<t;i++){const t=e.next().value;if(void 0===t)break;this.store.delete(t)}}getMaxEntries(){return this.maxEntries}async destroy(){this.store.clear()}}),A=class{constructor(i){t(this,i),this.clickCell=e(this,"clickCell"),this.clickAction=e(this,"clickAction"),this.valueChanged=e(this,"valueChanged"),this.cellWillValueChanged=e(this,"cellWillValueChanged"),this.cellValueChanged=e(this,"cellValueChanged"),this.cellDidValueChanged=e(this,"cellDidValueChanged"),this.cellValueChangedOnBlur=e(this,"cellValueChangedOnBlur")}_logger=l();__cellValueEditingEvent;get host(){return h(this)}cellData;cellType="text";isDisabled=!1;prependText;appendText;table;row;index;column;timeStamp;clickCell;clickAction;valueChanged;cellWillValueChanged;cellValueChanged;cellDidValueChanged;cellValueChangedOnBlur;valueChangedHandler(t){if(!this.column?.field)return;const e={id:r(this.row,this.table.fieldId),field:this.column.field,value:t.detail};this.cellWillValueChanged.emit(e)}cellWillValueChangedHandler(t){this._logger("cellWillValueChangedHandler",t.detail),"stencil"===this.table.sidePagination&&this.cellValueChanged.emit(t.detail)}cellValueChangedHandler(t){this._logger("cellValueChangedHandler",t.detail),o(this.row,this.column.field,t.detail.value),"stencil"===this.table.sidePagination&&this.cellDidValueChanged.emit(t.detail)}cellDidValueChangedHandler(t){this.host.querySelector(":focus")?this.__cellValueEditingEvent=t.detail:null!=this.__cellValueEditingEvent&&(this.__cellValueEditingEvent=t.detail,this.__emitCellValueChangedOnBlur()),this.rerender()}focusoutHandler(t){this.__cellValueEditingEvent&&this.__emitCellValueChangedOnBlur()}rerender=x((()=>{a(this)}),100);async dispatchCustomEvent(t,e){this[t]&&"function"==typeof this[t].emit&&this[t].emit(e)}renderSerialNumber(){return(this.table.pageNumber-1)*this.table.pageSize+this.index+1}renderDetail(){return i(y,{onToggle:t=>{const e=this.table.host.shadowRoot.querySelector('.row-detail[data-index="'+this.index+'"]');e&&e.classList.toggle("d-none",!t)}})}renderActionControl(){return i("storm-table-toolbar",{table:this.table,column:this.column,row:this.row,timeStamp:this.timeStamp,onClickAction:t=>{t.stopPropagation(),this.clickAction.emit(t.detail)}})}renderInputControl(){const t={type:w.Text,mode:v.Single,enableTime:!1,noCalendar:!1,dateFormat:"Y-m-d",...c(this.cellData)};return i("storm-input-group",{disabled:this.isDisabled,value:r(this.row,this.column.field),type:t.type,mode:t.mode,enableTime:t.enableTime,noCalendar:t.noCalendar,dateFormat:t.dateFormat,onClick:t=>t.stopPropagation(),onValueChanged:t=>{t.stopPropagation(),this.valueChanged.emit(t.target.value)}})}renderTextareaControl(){const t=this.cellData;return i("div",{class:"input-group input-group-static"},i("textarea",{class:"form-control",disabled:this.isDisabled,cols:t.cols,rows:t.rows,title:this.column.title,value:r(this.row,this.column.field),onClick:t=>t.stopPropagation(),onChange:t=>{t.stopPropagation(),this.valueChanged.emit(t.target.value)}}))}renderDropdownControl(){const t={label:null,dataSet:null,nullable:!1,searchable:!0,...c(this.cellData)};return i("storm-dropdown",{disabled:this.isDisabled,label:t.label,value:r(this.row,this.column.field),dataSet:t.dataSet,nullable:t.nullable,searchable:t.searchable,selection:"single",timeStamp:this.timeStamp,type:"select",onValueChanged:t=>{t.stopPropagation(),this.valueChanged.emit(t.detail)}})}renderDropdownTreeControl(){const t=this.cellData;let e=t.dataSet;if(t.dataSets&&d(t.dataSets)){const i=t.dataSets.find((t=>u(t.conditions)&&p(t.conditions,this.row)));i&&(e=i.value)}return i("storm-dropdown-tree",{disabled:this.isDisabled,loading:t.loading,partialLoad:t.partialLoad,label:t.label,value:r(this.row,this.column.field),text:t.fieldText?r(this.row,t.fieldText):null,dataSet:e,dataSource:t.dataSource,fieldId:t.fieldId??"id",fieldLabel:t.fieldLabel??"label",fieldChildren:t.fieldChildren??"children",expandLevel:t.expandLevel??2,nodeSelectableRule:t.nodeSelectableRule,nullable:t.nullable??!1,searchable:t.searchable??!0,selection:"single",timeStamp:this.timeStamp,onValueChanged:t=>{t.stopPropagation(),this.valueChanged.emit(t.detail)},onTextChanged:e=>{e.stopPropagation(),t.fieldText&&o(this.row,t.fieldText,e.detail)},onSearchChanged:t=>{t.stopPropagation()}})}renderCheckControl(){return i("storm-checkbox",{type:"checkbox"===this.cellType?"checkbox":"radio","is-disabled":this.isDisabled,"is-checked":r(this.row,this.column.field),"time-stamp":this.timeStamp})}renderCheckboxGroupControl(){const t=this.cellData,e=r(this.row,this.column.field),s=t.dataSet.filter((t=>void 0===t.visible||("function"==typeof t.visible?t.visible(this.row):t.visible))).map((t=>({id:t.id,label:t.label,labelClasses:t.labelClasses,checked:t.checked,disabled:t.disabled})));return i("div",{class:"input-group input-group-static"},i("storm-checkbox-group",{disabled:this.isDisabled,type:t.groupType,value:e,dataSet:s,isSwitch:t.isSwitch??!1,isInline:t.isInline??!0,onValueChanged:t=>{t.stopPropagation(),this.valueChanged.emit(t.detail)}}))}renderCellContent(){switch(this.cellType){case"action":return this.renderActionControl();case"input":return this.renderInputControl();case"checkbox":case"radio":return this.renderCheckControl();case"textarea":return this.renderTextareaControl();case"dropdown":return this.renderDropdownControl();case"dropdownTree":return this.renderDropdownTreeControl();case"checkboxGroup":return this.renderCheckboxGroupControl();case"serialNumber":return this.renderSerialNumber();case"detail":return this.renderDetail();case"text":return this.renderCellValue();case"empty":return"";default:return null}}renderCell(){return this.prependText||this.appendText?i("div",{class:"d-flex flex-row gap-1 align-items-center"},this.prependText&&i("span",null,this.prependText),this.renderCellContent(),this.appendText&&i("span",null,this.appendText)):this.renderCellContent()}renderCellValue(){let t=r(this.row,this.column.field);"function"==typeof this.column.render?t=this.column.render(t,this.row,this.index):(Array.isArray(t)&&(t=t.filter((t=>null!=t&&""!==t)).join("、")),this.table.escape&&"boolean"!=typeof t&&null!=t&&(t=S.encode(String(t))),null!=t&&this.column.transform&&this.column.transform[t.toString()]?t=this.column.transform[t]:t&&this.table.searchable&&this.table.searchText&&(t=b(t,this.table.searchText)));const e=this.column.cellTemplate||this.table.cellTemplate,s=null!=t&&t.toString().trim().length>0?t:"-";return i("span",{innerHTML:m(e,{value:s,row:this.row,index:this.index})})}async componentWillRender(){if(!this.column)return void this.resetCellState();const[t,e]=await Promise.all([this.resolvePropertyValueAsync(this.column,"cellType"),this.resolvePropertyValueAsync(this.column,"data")]);if(this.cellType=t||this.column.type||"text",this.cellData=e,!this.cellData||"object"!=typeof this.cellData||Array.isArray(this.cellData))return void this.resetControlState();const[i,s,h]=await Promise.all([this.resolvePropertyValueAsync(this.cellData,"disabled"),this.resolvePropertyValueAsync(this.cellData,"prependText"),this.resolvePropertyValueAsync(this.cellData,"appendText")]);this.isDisabled=i??!1,this.prependText=s,this.appendText=h,!this.isDisabled||"input"!==this.cellType&&"textarea"!==this.cellType||(this.cellType="text")}resetCellState(){this.cellType="text",this.cellData=void 0,this.resetControlState()}resetControlState(){this.isDisabled=!1,this.prependText=void 0,this.appendText=void 0,this.__cellValueEditingEvent=void 0}async resolvePropertyValueAsync(t,e){const i=f(t,e,[this.row,this.index,this.column]);if("string"==typeof(s=i)&&/^@[a-zA-Z0-9:-]+\('.*'\)$/.test(s.trim()))return this.handleCommandString(i);var s;if(u(i))return p(i,this.row);if(d(i))return this.evaluateConditionGroups(i);if(i instanceof Promise)try{return await i}catch(t){throw console.error("屬性 Promise 解析失敗",t),t}return i}async handleCommandString(t){const e=function(t){const e=t.trim(),i=/^@([a-zA-Z0-9:-]+)\('([^']*)'\)$/.exec(e);return i?{command:i[1],value:i[2]}:null}(t);if("Invoke:DotNet"===e.command){const t=r(this.row,this.table?.fieldId);try{return await async function(t,e=[],i={}){if("string"!=typeof t)throw new TypeError("methodName 必須是字串");i={cache:!0,regionName:"dotnetInterop",...i};const s=`${t}:${JSON.stringify(e)}`,h=i.cache;if(h){const t=await _.get(s);if(null!==t)return t}try{const i=await(window.counterInterop?.invokeMethodAsync(t,...e));return h&&await _.set(s,i),i}catch(e){return console.error(`[Interop] 無法呼叫 '${t}'：`,e),"unknown"}}(e.value,[t,this.index,this.column.field],{cache:!0})}catch(t){throw console.error("InvokeDotNetMethod 執行失敗",t),t}}return"Get:Field"===e.command?r(this.row,e.value):t}evaluateConditionGroups(t){for(const e of t)if(u(e.conditions)&&p(e.conditions,this.row))return e.value}__emitCellValueChangedOnBlur=x((()=>{void 0!==this.__cellValueEditingEvent&&(this.cellValueChangedOnBlur.emit(this.__cellValueEditingEvent),this.__cellValueEditingEvent=void 0)}),500);render(){return i(s,{key:"d89533ef275bb705d1779072552de2c9b23a1b02",onClick:t=>{if("checkbox"===this.cellType||"radio"===this.cellType){t.stopPropagation(),t.preventDefault();const e=this.cellData;if(e&&e.disabled)return}this.clickCell.emit({id:r(this.row,this.table.fieldId),field:this.column.field})}},this.renderCell())}};A.style=":host{display:block}.input-group.input-group-static .form-control{background-color:white;line-height:1.25rem;padding:0.25rem}.detail-button{cursor:pointer}";const D=class{constructor(i){t(this,i),this.clickAction=e(this,"clickAction")}__dateSet;get host(){return h(this)}table;column;row;isDynamicLabel=!0;timeStamp;clickAction;componentWillRender(){this.__dateSet=this.column.buttons?.map((t=>({id:t.id,type:t.type,label:t.label,tooltip:t.tooltip,icon:t.icon,size:"sm",buttonStyle:"outline-primary",rounded:!0,visible:()=>u(t.visible)?p(t.visible,this.row):g(this,t.visible,this.row,this.table,r(this.row,this.table.fieldIndex))??!0,disabled:()=>u(t.disabled)?p(t.disabled,this.row):g(this,t.disabled,this.row,this.table,r(this.row,this.table.fieldIndex))??!1,items:t.items?t.items.map((t=>({id:t.id,title:t.title,icon:t.icon,selected:t.selected,visible:()=>u(t.visible)?p(t.visible,this.row):g(this,t.visible,this.row,this.table,r(this.row,this.table.fieldIndex))??!0,disabled:()=>u(t.disabled)?p(t.disabled,this.row):g(this,t.disabled,this.row,this.table,r(this.row,this.table.fieldIndex))??!1}))):null,click:(e,i=null)=>{t.action&&t.action(this.row,t,this.table,i),this.clickAction.emit({id:r(this.row,this.table.fieldId),field:this.column.field,actionId:t.id,dropdownItemId:i?i.id:null})}})))}render(){return i(s,{key:"bb5b59f7d7045d641e945e7caa9d5829baeceb99"},i("storm-toolbar",{key:"5bf34fd9adb8d6daccd825ffc08917602482c6d2",class:{"storm-dynamic-label":this.isDynamicLabel,"justify-content-start":"left"===this.column.align,"justify-content-center":"center"===this.column.align,"justify-content-end":"right"===this.column.align},dataSet:this.__dateSet,timeStamp:this.timeStamp}))}};D.style=":host{display:block}:host storm-button,:host storm-dropdown,:host div{vertical-align:middle}:host .btn:hover:not(.active){color:white}:host .btn.btn-outline-primary:hover{background-color:#e91e63}:host .btn.disabled{color:#7b809a;border-color:#7b809a;cursor:not-allowed}";export{k as storm_checkbox_group,V as storm_dropdown_tree,A as storm_table_cell,D as storm_table_toolbar}