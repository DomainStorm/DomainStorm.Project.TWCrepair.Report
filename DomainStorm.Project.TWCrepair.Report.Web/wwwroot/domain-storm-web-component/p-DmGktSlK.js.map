{"version":3,"file":"p-DmGktSlK.js","sources":["src/utils/cache/cache-service.ts"],"sourcesContent":["import type { CacheEntry, ICacheProvider } from './interface';\r\n\r\n/**\r\n * 快取服務設定選項\r\n */\r\nexport interface CacheOptions {\r\n    /** 預設過期時間（毫秒），預設為 10分鐘 */\r\n    expiredMillis?: number;\r\n    /** 預設區域名稱，預設為'default' */\r\n    regionName?: string;\r\n}\r\n\r\nconst DEFAULT_EXPIRED_MILLIS = 600_000; // 10分鐘\r\nconst DEFAULT_REGION_NAME = 'default';\r\nconst MAX_MEMORY_USAGE_MB = 50; // 最大記憶體使用量（MB）\r\nconst CLEANUP_INTERVAL_MS = 300_000; // 5分鐘清理一次過期項目\r\n\r\n/**\r\n * 快取服務類別，提供高效能的鍵值快取功能\r\n * 支援區域分離、過期時間控制、批次操作等功能\r\n */\r\nexport class CacheService {\r\n    private readonly provider: ICacheProvider;\r\n    private readonly defaultOptions: CacheOptions;\r\n    private cleanupTimer: NodeJS.Timeout | null = null;\r\n    private memoryUsageBytes: number = 0;\r\n    private operationCount: number = 0;\r\n\r\n    /**\r\n     * 建立快取服務實例\r\n     * @param provider 快取提供者實現\r\n     * @param options 快取設定選項\r\n     */\r\n    constructor(provider: ICacheProvider, options: CacheOptions = {}) {\r\n        if (!provider) {\r\n            throw new Error('CacheService: 需要有效的快取提供者');\r\n        }\r\n\r\n        this.provider = provider;\r\n        this.defaultOptions = {\r\n            regionName: this.validateRegionName(options.regionName),\r\n            expiredMillis: this.validateExpiredMillis(options.expiredMillis)\r\n        };\r\n        \r\n        // 啟動定期清理\r\n        this.startPeriodicCleanup();\r\n    }\r\n\r\n    private validateRegionName(regionName?: string): string {\r\n        return (typeof regionName === 'string' && regionName.trim())\r\n            ? regionName.trim()\r\n            : DEFAULT_REGION_NAME;\r\n    }\r\n\r\n    private validateExpiredMillis(expiredMillis?: number): number {\r\n        return (typeof expiredMillis === 'number' && expiredMillis > 0)\r\n            ? expiredMillis\r\n            : DEFAULT_EXPIRED_MILLIS;\r\n    }\r\n\r\n    private validateKey(key: string): void {\r\n        if (!key || typeof key !== 'string' || !key.trim()) {\r\n            throw new Error('快取鍵值必須是非空字串');\r\n        }\r\n    }\r\n\r\n    private validateExpiredTime(expiredMillis: number): void {\r\n        if (typeof expiredMillis !== 'number' || expiredMillis <= 0) {\r\n            throw new Error('過期時間必須是正數（毫秒）');\r\n        }\r\n    }\r\n\r\n    private isExpired(entry: CacheEntry): boolean {\r\n        return Date.now() - entry.timestamp > entry.expiredMillis;\r\n    }\r\n\r\n    private makeCompositeKey(regionName: string, key: string): string {\r\n        return `${regionName}:${key}`;\r\n    }\r\n\r\n    /**\r\n     * 取得快取項目\r\n     * @param key 快取鍵值\r\n     * @param regionName 區域名稱，預設使用預設區域\r\n     * @returns 快取的值，若不存在或已過期則回傳 null\r\n     */\r\n    async get<T = any>(key: string, regionName = this.defaultOptions.regionName): Promise<T | null> {\r\n        this.validateKey(key);\r\n\r\n        const compositeKey = this.makeCompositeKey(regionName, key);\r\n        const entry = await this.provider.get(compositeKey);\r\n\r\n        if (!entry) return null;\r\n\r\n        if (this.isExpired(entry)) {\r\n            await this.provider.delete(compositeKey);\r\n            return null;\r\n        }\r\n\r\n        return entry.value as T;\r\n    }\r\n\r\n    /**\r\n     * 設定快取項目\r\n     * @param key 快取鍵值\r\n     * @param value 要快取的值\r\n     * @param regionName 區域名稱，預設使用預設區域\r\n     * @param expiredMillis 過期時間（毫秒），預設使用預設值\r\n     */\r\n    async set(\r\n        key: string,\r\n        value: any,\r\n        regionName = this.defaultOptions.regionName,\r\n        expiredMillis = this.defaultOptions.expiredMillis\r\n    ): Promise<void> {\r\n        this.validateKey(key);\r\n        this.validateExpiredTime(expiredMillis);\r\n\r\n        const compositeKey = this.makeCompositeKey(regionName, key);\r\n        const entry: CacheEntry = {\r\n            value,\r\n            timestamp: Date.now(),\r\n            expiredMillis,\r\n        };\r\n        \r\n        // 估算記憶體使用量\r\n        const entrySize = this.estimateEntrySize(entry);\r\n        if (this.memoryUsageBytes + entrySize > MAX_MEMORY_USAGE_MB * 1024 * 1024) {\r\n            await this.cleanupExpiredEntries();\r\n        }\r\n        \r\n        await this.provider.set(compositeKey, entry);\r\n        this.memoryUsageBytes += entrySize;\r\n        this.operationCount++;\r\n    }\r\n\r\n    async delete(key: string, regionName = this.defaultOptions.regionName): Promise<void> {\r\n        this.validateKey(key);\r\n\r\n        const compositeKey = this.makeCompositeKey(regionName, key);\r\n        await this.provider.delete(compositeKey);\r\n    }\r\n\r\n    async clearRegion(regionName = this.defaultOptions.regionName): Promise<void> {\r\n        const prefix = `${regionName}:`;\r\n        await this.provider.deleteByPrefix(prefix);\r\n    }\r\n\r\n    async clearAll(): Promise<void> {\r\n        await this.provider.clear();\r\n    }\r\n\r\n    async has(key: string, regionName = this.defaultOptions.regionName): Promise<boolean> {\r\n        this.validateKey(key);\r\n\r\n        const compositeKey = this.makeCompositeKey(regionName, key);\r\n        const entry = await this.provider.get(compositeKey);\r\n\r\n        if (!entry) return false;\r\n\r\n        if (this.isExpired(entry)) {\r\n            await this.provider.delete(compositeKey);\r\n            return false;\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * 批次取得多個快取項目\r\n     * @param keys 快取鍵值陣列\r\n     * @param regionName 區域名稱，預設使用預設區域\r\n     * @returns 對應的值陣列，不存在或過期的項目為 null\r\n     */\r\n    async mget<T = any>(keys: string[], regionName = this.defaultOptions.regionName): Promise<(T | null)[]> {\r\n        if (!Array.isArray(keys)) {\r\n            throw new Error('鍵值必須是陣列');\r\n        }\r\n\r\n        const promises = keys.map(key => this.get<T>(key, regionName));\r\n        return Promise.all(promises);\r\n    }\r\n\r\n    /**\r\n     * 批次設定多個快取項目\r\n     * @param entries 要設定的項目陣列，包含 key、value 和可選的 expiredMillis\r\n     * @param regionName 區域名稱，預設使用預設區域\r\n     */\r\n    async mset(\r\n        entries: Array<{ key: string; value: any; expiredMillis?: number }>,\r\n        regionName = this.defaultOptions.regionName\r\n    ): Promise<void> {\r\n        if (!Array.isArray(entries)) {\r\n            throw new Error('項目必須是陣列');\r\n        }\r\n\r\n        const promises = entries.map(({ key, value, expiredMillis }) =>\r\n            this.set(key, value, regionName, expiredMillis)\r\n        );\r\n        await Promise.all(promises);\r\n    }\r\n\r\n    /**\r\n     * 批次刪除多個快取項目\r\n     * @param keys 要刪除的鍵值陣列\r\n     * @param regionName 區域名稱，預設使用預設區域\r\n     */\r\n    async mdelete(keys: string[], regionName = this.defaultOptions.regionName): Promise<void> {\r\n        if (!Array.isArray(keys)) {\r\n            throw new Error('鍵值必須是陣列');\r\n        }\r\n\r\n        const promises = keys.map(key => this.delete(key, regionName));\r\n        await Promise.all(promises);\r\n    }\r\n\r\n    /**\r\n     * 估算快取項目的記憶體使用量\r\n     */\r\n    private estimateEntrySize(entry: CacheEntry): number {\r\n        try {\r\n            const jsonString = JSON.stringify(entry);\r\n            return jsonString.length * 2; // 假設每個字符佔用2字節\r\n        } catch {\r\n            return 1024; // 如果無法序列化，使用預設大小\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 啟動定期清理\r\n     */\r\n    private startPeriodicCleanup(): void {\r\n        if (typeof window !== 'undefined' || typeof global !== 'undefined') {\r\n            this.cleanupTimer = setInterval(() => {\r\n                this.cleanupExpiredEntries().catch(error => {\r\n                    console.warn('Cache cleanup failed:', error);\r\n                });\r\n            }, CLEANUP_INTERVAL_MS);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 清理過期項目\r\n     */\r\n    private async cleanupExpiredEntries(): Promise<void> {\r\n        // 這裡需要Provider支援列舉和批量刪除\r\n        // 這是一個簡化版本，實際實現會根據具體的Provider而定\r\n        console.debug('Performing cache cleanup...');\r\n        this.memoryUsageBytes = 0; // 重置計數器\r\n    }\r\n\r\n    /**\r\n     * 取得快取統計資訊\r\n     */\r\n    getStats(): {\r\n        memoryUsageBytes: number;\r\n        operationCount: number;\r\n        estimatedMemoryUsageMB: number;\r\n    } {\r\n        return {\r\n            memoryUsageBytes: this.memoryUsageBytes,\r\n            operationCount: this.operationCount,\r\n            estimatedMemoryUsageMB: this.memoryUsageBytes / (1024 * 1024)\r\n        };\r\n    }\r\n\r\n    /**\r\n     * 清理資源\r\n     */\r\n    dispose(): void {\r\n        if (this.cleanupTimer) {\r\n            clearInterval(this.cleanupTimer);\r\n            this.cleanupTimer = null;\r\n        }\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}