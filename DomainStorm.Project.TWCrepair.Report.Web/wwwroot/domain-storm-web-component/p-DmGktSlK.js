const t=6e5;const e="default";const i=50;const s=3e5;class r{provider;defaultOptions;cleanupTimer=null;memoryUsageBytes=0;operationCount=0;constructor(t,e={}){if(!t){throw new Error("CacheService: 需要有效的快取提供者")}this.provider=t;this.defaultOptions={regionName:this.validateRegionName(e.regionName),expiredMillis:this.validateExpiredMillis(e.expiredMillis)};this.startPeriodicCleanup()}validateRegionName(t){return typeof t==="string"&&t.trim()?t.trim():e}validateExpiredMillis(e){return typeof e==="number"&&e>0?e:t}validateKey(t){if(!t||typeof t!=="string"||!t.trim()){throw new Error("快取鍵值必須是非空字串")}}validateExpiredTime(t){if(typeof t!=="number"||t<=0){throw new Error("過期時間必須是正數（毫秒）")}}isExpired(t){return Date.now()-t.timestamp>t.expiredMillis}makeCompositeKey(t,e){return`${t}:${e}`}async get(t,e=this.defaultOptions.regionName){this.validateKey(t);const i=this.makeCompositeKey(e,t);const s=await this.provider.get(i);if(!s)return null;if(this.isExpired(s)){await this.provider.delete(i);return null}return s.value}async set(t,e,s=this.defaultOptions.regionName,r=this.defaultOptions.expiredMillis){this.validateKey(t);this.validateExpiredTime(r);const a=this.makeCompositeKey(s,t);const n={value:e,timestamp:Date.now(),expiredMillis:r};const o=this.estimateEntrySize(n);if(this.memoryUsageBytes+o>i*1024*1024){await this.cleanupExpiredEntries()}await this.provider.set(a,n);this.memoryUsageBytes+=o;this.operationCount++}async delete(t,e=this.defaultOptions.regionName){this.validateKey(t);const i=this.makeCompositeKey(e,t);await this.provider.delete(i)}async clearRegion(t=this.defaultOptions.regionName){const e=`${t}:`;await this.provider.deleteByPrefix(e)}async clearAll(){await this.provider.clear()}async has(t,e=this.defaultOptions.regionName){this.validateKey(t);const i=this.makeCompositeKey(e,t);const s=await this.provider.get(i);if(!s)return false;if(this.isExpired(s)){await this.provider.delete(i);return false}return true}async mget(t,e=this.defaultOptions.regionName){if(!Array.isArray(t)){throw new Error("鍵值必須是陣列")}const i=t.map((t=>this.get(t,e)));return Promise.all(i)}async mset(t,e=this.defaultOptions.regionName){if(!Array.isArray(t)){throw new Error("項目必須是陣列")}const i=t.map((({key:t,value:i,expiredMillis:s})=>this.set(t,i,e,s)));await Promise.all(i)}async mdelete(t,e=this.defaultOptions.regionName){if(!Array.isArray(t)){throw new Error("鍵值必須是陣列")}const i=t.map((t=>this.delete(t,e)));await Promise.all(i)}estimateEntrySize(t){try{const e=JSON.stringify(t);return e.length*2}catch{return 1024}}startPeriodicCleanup(){if(typeof window!=="undefined"||typeof global!=="undefined"){this.cleanupTimer=setInterval((()=>{this.cleanupExpiredEntries().catch((t=>{console.warn("Cache cleanup failed:",t)}))}),s)}}async cleanupExpiredEntries(){console.debug("Performing cache cleanup...");this.memoryUsageBytes=0}getStats(){return{memoryUsageBytes:this.memoryUsageBytes,operationCount:this.operationCount,estimatedMemoryUsageMB:this.memoryUsageBytes/(1024*1024)}}dispose(){if(this.cleanupTimer){clearInterval(this.cleanupTimer);this.cleanupTimer=null}}}export{r as C};
//# sourceMappingURL=p-DmGktSlK.js.map