import{r as t,c as e,h as i,H as s,a as h,f as n}from"./p-KLuYAdjz.js";import{p as r,g as a,a as c,s as o,f as l,i as d,b as u,e as f}from"./p-DsqHBQPh.js";import{F as m,a as p}from"./p-CgOkwgoa.js";import{d as w}from"./p-9Du3dL5x.js";import{C as k}from"./p-pMD06zDP.js";import{S as g}from"./p-CAnyxfG4.js";import"./p-E-ZsRS8r.js";const y=()=>`:host{display:block}:host>.form-check{padding-left:0.25rem}:host>.form-check.form-switch{padding-left:2.75rem}:host>.form-check.form-switch .form-check-input{margin-top:.3rem}:host>.form-check.form-check-inline{margin-right:.75rem}:host>.form-check:not(.form-switch) .form-check-input[type=checkbox]{margin-top:0}:host .input-group.input-group-static label{margin-left:.25rem;margin-top:.15rem}:host label{cursor:pointer}`;const b=class{constructor(i){t(this,i);this.valueChanged=e(this,"valueChanged")}_uid;_inputEl;type="checkbox";label;labelClasses="custom-control-label";isDisabled;isChecked;isIndeterminate;isSwitch=false;isInline=false;timeStamp;valueChanged;async check(){if(this.isChecked)return;this.isChecked=true;this.valueChanged.emit(this.isChecked)}async uncheck(){if(!this.isChecked)return;this.isChecked=false;this.valueChanged.emit(this.isChecked)}renderLabel(){if(!this.label)return;return i("label",{htmlFor:this._uid,class:r(this.labelClasses)},this.label)}componentDidRender(){if(this._inputEl){this._inputEl.indeterminate=!!this.isIndeterminate}}render(){if(!this._uid)this._uid=a("storm-checkbox");return i(s,{key:"533ee62f567d7158ec6b46d3988b60ffbbac6134"},i("div",{key:"e3717e9c39a8e883fcef35dae417156baf6c4148",class:{"form-check":true,"form-check-inline":this.isInline,"form-switch":this.isSwitch}},i("input",{key:"b140fd51708ed36e67e047735a8b740669686273",ref:t=>this._inputEl=t,class:{"form-check-input":true},id:this._uid,type:this.type,checked:this.isChecked,disabled:this.isDisabled,indeterminate:this.isIndeterminate,onChange:async t=>{t.stopPropagation();if(t.target["checked"])await this.check();else await this.uncheck()}}),this.renderLabel()))}};b.style=y();const C=()=>`:host{display:block;-webkit-user-select:none;user-select:none}.list-group-item.active .form-check:not(.form-switch) .form-check-input[type="checkbox"]:checked{background:#fff !important;border-color:#fff !important}.list-group-item.active .form-check:not(.form-switch) .form-check-input[type="checkbox"]::after{color:#e91e63 !important}.list-group-item .form-check{margin-bottom:0 !important}`;const S=class{constructor(i){t(this,i);this.nodeSelect=e(this,"nodeSelect");this.nodeUnselect=e(this,"nodeUnselect");this.nodeClick=e(this,"nodeClick");this.nodeDblClick=e(this,"nodeDblClick");this.nodeCheck=e(this,"nodeCheck");this.nodeUncheck=e(this,"nodeUncheck")}_child;get host(){return h(this)}href="javascript:void(0);";dataSet;tree;parent;content;searchText;nodeSelect;nodeUnselect;nodeClick;nodeDblClick;nodeCheck;nodeUncheck;async handleNodeClick(t){if(t.detail!==this.getId())return;if(this.getSelectable()){if(!this.getSelected()){await this.select()}else if(this.tree.nullable){await this.unselect()}}else{t.stopPropagation();if(this.hasChild()){this.expandToggle()}}}expandToggle(){this.getExpanded()?this.collapse():this.expand()}getId(){return c(this.dataSet,this.tree.fieldId)}getHref(){const t=c(this.dataSet,this.tree.fieldHref);return t??this.href}getChild(){return c(this.dataSet,this.tree.fieldChildren)||[]}getSelectable(){const t=c(this.dataSet,this.tree.fieldSelectable);return t??this.tree.selection!="none"}getCheckSelectable(){return c(this.dataSet,this.tree.fieldCheckSelectable)===true}getSelected(){return c(this.dataSet,this.tree.fieldSelected)===true}getChecked(){return c(this.dataSet,this.tree.fieldChecked)===true}getDisabled(){return c(this.dataSet,this.tree.fieldDisabled)===true}setSelected(t){if(c(this.dataSet,this.tree.fieldSelected)===t)return;o(this.dataSet,this.tree.fieldSelected,t);this.rerender()}setChecked(t){if(c(this.dataSet,this.tree.fieldChecked)===t)return;o(this.dataSet,this.tree.fieldChecked,t);this.rerender()}getExpanded(){return c(this.dataSet,this.tree.fieldExpanded)===true}async setExpanded(t){if(this.getExpanded()===t)return;o(this.dataSet,this.tree.fieldExpanded,t);if(t&&!c(this.dataSet,this.tree.fieldChildLoaded)){await this.tree.loadChild(this)}this.rerender()}rerender=w((()=>{n(this)}),50);async select(){if(this.getSelected()){return}this.setSelected(true);this.nodeSelect.emit(this.getId())}async unselect(){if(!this.getSelected()){return}this.setSelected(false);this.nodeUnselect.emit(this.getId())}async check(){if(this.getChecked()){return}this.setChecked(true);this.nodeCheck.emit(this.getId())}async uncheck(){if(!this.getChecked()){return}this.setChecked(false);this.nodeUncheck.emit(this.getId())}async expand(){await this.setExpanded(true)}async collapse(){await this.setExpanded(false)}hasChild(){return!!this.getChild()?.length}renderExpandIcon(){if(this.searchText)return;if(!this.hasChild()||this.getExpanded()&&this.tree.collapseIcon===""||!this.getExpanded()&&this.tree.expandIcon===""){return this.tree.expandIconAlign==="left"?i("span",{class:"indent"}):undefined}const t={"mb-1":true,"mx-1":true,"position-absolute":this.tree.expandIconAlign==="right","end-0":this.tree.expandIconAlign==="right"};return i("span",{class:t,onClick:t=>{t.stopPropagation();this.expandToggle()}},i(m,null,this.getExpanded()?this.tree.collapseIcon:this.tree.expandIcon))}renderIndent(){if(this.searchText)return;const t=[];const e=c(this.dataSet,this.tree.fieldLevel);for(let s=1;s<e;s++){t.push(i("span",{class:"indent"}))}if(!this.hasChild()&&this.tree.expandIconAlign==="left"){t.push(i("span",{class:"leaf"}))}return t}renderChild(){if(this.searchText)return;if(!this.hasChild()||!this.getExpanded())return;this._child=this.getChild().map((t=>this.renderNodeItem(t)));return i("div",{class:"list-group"},this._child)}renderNodeItem(t){let e=c(t,this.tree.fieldLabel);if(e&&this.searchText){e=l(e,this.searchText)}const s=i("storm-tree-node",{tree:this.tree,dataSet:t,content:e,searchText:this.searchText});return s}renderLabel(){return i("span",{innerHTML:this.content})}componentWillLoad(){o(this.dataSet,this.tree.fieldElement,this)}renderCheckbox(){if(!this.getCheckSelectable())return;return i("storm-checkbox",{type:"checkbox",isInline:true,isChecked:this.getChecked(),onValueChanged:t=>{t.stopPropagation()},onClick:async t=>{t.stopPropagation();if(this.tree.selectToCheck){this.nodeClick.emit(this.getId())}else if(!this.getChecked()){await this.check()}else{await this.uncheck()}}})}render(){if(!this.dataSet)return;return i(s,null,i("a",{href:this.getHref(),class:{"py-1":true,"px-1":true,"list-group-item":true,"list-group-item-action":c(this.dataSet,this.tree.fieldSelectable),"list-group-item-primary":this.tree.color=="primary","list-group-item-secondary":this.tree.color=="secondary","list-group-item-success":this.tree.color=="success","list-group-item-danger":this.tree.color=="danger","list-group-item-warning":this.tree.color=="warning","list-group-item-info":this.tree.color=="info","list-group-item-light":this.tree.color=="light","list-group-item-dark":this.tree.color=="dark","d-flex":true,"align-items-end":true,active:this.getSelected(),disabled:this.getDisabled()},onClick:t=>{t.stopPropagation();this.nodeClick.emit(this.getId())},onDblClick:t=>{t.stopPropagation();this.nodeDblClick.emit(this.getId())}},this.renderIndent(),this.renderExpandIcon(),i(m,null,c(this.dataSet,this.tree.fieldIcon)),this.renderCheckbox(),this.renderLabel()),this.renderChild())}disconnectedCallback(){o(this.dataSet,this.tree.fieldElement,undefined)}};S.style=C();class x{dbPromise=null;maxEntries;dbName;dbVersion;constructor(t=1e3,e="StencilCacheDB",i=1){this.maxEntries=Math.max(1,t);this.dbName=e;this.dbVersion=i}openDB(){if(!this.dbPromise){this.dbPromise=new Promise(((t,e)=>{const i=window.indexedDB.open(this.dbName,this.dbVersion);i.onupgradeneeded=t=>{const e=t.target.result;if(!e.objectStoreNames.contains("cache")){const t=e.createObjectStore("cache",{keyPath:"key"});t.createIndex("timestamp","timestamp",{unique:false})}};i.onsuccess=e=>{t(e.target.result)};i.onerror=()=>{this.dbPromise=null;e(i.error)}}))}return this.dbPromise}async withTransaction(t,e){const i=await this.openDB();const s=i.transaction("cache",t);return await e(s.objectStore("cache"))}async get(t){return await this.withTransaction("readonly",(e=>new Promise(((i,s)=>{const h=e.get(t);h.onsuccess=()=>{const t=h.result;i(t?{value:t.value,timestamp:t.timestamp,ttlMillis:t.ttlMillis}:null)};h.onerror=()=>s(h.error)}))))}async set(t,e){await this.withTransaction("readwrite",(i=>new Promise(((s,h)=>{const n=i.get(t);n.onsuccess=()=>{const r=n.result;const a=()=>{const n=i.put({key:t,...e});n.onsuccess=()=>s();n.onerror=()=>h(n.error)};if(r){a()}else{const t=i.count();t.onsuccess=()=>{if(t.result>=this.maxEntries){this.evictOldestEntry(i,a,h)}else{a()}};t.onerror=()=>h(t.error)}};n.onerror=()=>h(n.error)}))))}evictOldestEntry(t,e,i){const s=t.index("timestamp");const h=s.openCursor();h.onsuccess=t=>{const s=t.target.result;if(s){const t=s.delete();t.onsuccess=e;t.onerror=()=>i(t.error)}else{e()}};h.onerror=()=>i(h.error)}async delete(t){await this.withTransaction("readwrite",(e=>new Promise(((i,s)=>{const h=e.delete(t);h.onsuccess=()=>i();h.onerror=()=>s(h.error)}))))}async clear(){await this.withTransaction("readwrite",(t=>new Promise(((e,i)=>{const s=t.clear();s.onsuccess=()=>e();s.onerror=()=>i(s.error)}))))}get defaultKeyPrefix(){return"idb"}async size(){return await this.withTransaction("readonly",(t=>new Promise(((e,i)=>{const s=t.count();s.onsuccess=()=>e(s.result);s.onerror=()=>i(s.error)}))))}setMaxEntries(t){this.maxEntries=t}getMaxEntries(){return this.maxEntries}async destroy(){if(this.dbPromise){const t=await this.dbPromise;t.close();this.dbPromise=null}return new Promise(((t,e)=>{const i=window.indexedDB.deleteDatabase(this.dbName);i.onsuccess=()=>t();i.onerror=()=>e(i.error);i.onblocked=()=>{console.warn("Database deletion blocked. Other connections may be open.");t()}}))}}const _=new k(new x,{regionName:"fetchDataSource"});async function v(t){t={method:"POST",contentType:"application/json",...t};const e=JSON.stringify(t);const i=await _.get(e);if(i!==null){return i}const s=await fetch(t.url,{method:t.method,body:t.method!=="GET"?JSON.stringify(t.body??{}):null,headers:new Headers({"Content-Type":t.contentType})});if(!s.ok){throw new Error(`Network response was not ok: ${s.statusText}`)}const h=t.contentType==="application/json"?await s.json():await s.text();await _.set(e,h);return h}const D=()=>`:host{display:block;background-color:#fff}:host .list-group-item{border:none !important;white-space:nowrap !important;cursor:pointer !important;margin-bottom:0 !important}:host .close.material-icons,:host .open.material-icons:hover{opacity:0.5}:host .open.material-icons,:host .close.material-icons:hover{opacity:1}:host .material-icons:empty{width:1.25rem}:host .indent{margin-left:0.575rem;margin-right:0.575rem}:host .leaf{margin-left:0.6rem}`;const H=class{constructor(i){t(this,i);this.dateSetLoaded=e(this,"dateSetLoaded");this.valueChanged=e(this,"valueChanged");this.nodeSelect=e(this,"nodeSelect");this.nodeUnselect=e(this,"nodeUnselect");this.nodeClick=e(this,"nodeClick");this.nodeDblClick=e(this,"nodeDblClick");this.nodeCheck=e(this,"nodeCheck");this.nodeUncheck=e(this,"nodeUncheck");this.checkedChanged=e(this,"checkedChanged");this.searchChanged=e(this,"searchChanged");this.keydown=e(this,"keydown")}_searchText;_dataSet;_items;_dataSource;_searchRef;_nodeSelectableRule;_nodeCheckRule;get host(){return h(this)}partialLoad=false;loading="eager";value;checked=[];fieldId="id";fieldLabel="label";fieldChildren="children";fieldSubId="subId";fieldSubLabel="subLabel";fieldSubChildren="subChildren";fieldSelected="_selected";fieldChecked="_checked";fieldExpanded="_expanded";fieldDisabled="_disabled";fieldParent="_parent";fieldSelectable="_selectable";fieldCheckSelectable="_checkSelectable";fieldIcon="_icon";fieldHref="_href";fieldLevel="_level";fieldChildLoaded="_loaded";fieldElement="_element";expandIconAlign="left";expandIcon;collapseIcon;color;dataSet;dataSource;fetch;nullable=true;expandLevel=2;structure="auto";searchable=false;selection="single";nodeSelectableRule;checkSelectable=false;nodeCheckRule;selectToCheck=true;dateSetLoaded;valueChanged;nodeSelect;nodeUnselect;nodeClick;nodeDblClick;nodeCheck;nodeUncheck;checkedChanged;searchChanged;keydown;async searchChangedHandler(t){this._searchText=t.detail;if(this.partialLoad){this.cleanNodes();await this.loadDataSet()}else{this.rerender()}}nodeSelectHandler(t){switch(this.selection){case"single":this.value=t.detail;break;case"multiple":{const e=Array.isArray(this.value)?this.value:this.value?[this.value]:[];if(!e.includes(t.detail))this.value=[...e,t.detail];break}default:console.warn(`Unknown selection mode: ${this.selection}`)}}nodeUnselectHandler(t){switch(this.selection){case"single":if(this.value===t.detail){this.value=null}break;case"multiple":{const e=Array.isArray(this.value)?this.value:[];if(e.includes(t.detail))this.value=e.filter((e=>e!==t.detail));break}default:console.warn(`Unknown selection mode: ${this.selection}`)}}nodeCheckHandler(t){if(this.selectToCheck)return;if(!this.checked.includes(t.detail))this.checked=[...this.checked,t.detail]}nodeUncheckHandler(t){if(this.selectToCheck)return;if(this.checked.includes(t.detail))this.checked=this.checked.filter((e=>e!==t.detail))}async valueChangedHandler(){if(!Array.isArray(this._items))return;const t=Array.isArray(this.value)?this.value:this.value?[this.value]:[];await Promise.all(this._items.map((async e=>{const i=String(c(e,this.fieldId));const s=t.includes(i);const h=c(e,this.fieldSelected)===true;const n=[];if(s){n.push(this.setNodeExpanded(e))}if(h!==s){n.push(this.setNodeSelectionState(e,s))}return Promise.all(n)})));if(this.checkSelectable&&this.selectToCheck){this.checked=t}}async checkedChangedHandler(){if(!Array.isArray(this._items))return;await Promise.all(this._items.map((t=>{const e=String(c(t,this.fieldId));const i=Array.isArray(this.checked)?this.checked:this.checked?[this.checked]:[];const s=i.includes(e);const h=c(t,this.fieldChecked)===true;if(h!==s){return this.setNodeCheckedState(t,s)}return Promise.resolve()})))}async watchValueHandler(){this.valueChanged.emit(this.value)}async watchCheckedHandler(){this.checkedChanged.emit(this.checked)}async setNodeSelectionState(t,e){const i=await this.getTreeNode(t);if(i){await(e?i.select():i.unselect())}else{o(t,this.fieldSelected,e)}if(this.checkSelectable&&this.selectToCheck){await this.setNodeCheckedState(t,e)}}async setNodeCheckedState(t,e){const i=await this.getTreeNode(t);if(i){await(e?i.check():i.uncheck())}else{o(t,this.fieldChecked,e)}}watchDataSourceHandler(){this.cleanNodes();if(typeof this.dataSource==="string"){if(d(this.dataSource)){this._dataSource=u(this.dataSource)}else if(this.dataSource.startsWith("{")&&this.dataSource.endsWith("}")){this._dataSource=JSON.parse(this.dataSource)}else{this._dataSource={url:this.dataSource}}}else{this._dataSource=this.dataSource}}watchNodeSelectableRuleHandler(){if(typeof this.nodeSelectableRule==="string"){if(d(this.nodeSelectableRule)){this._nodeSelectableRule=u(this.nodeSelectableRule)}}else{this._nodeSelectableRule=this.nodeSelectableRule}}watchNodeCheckRuleHandler(){if(typeof this.nodeCheckRule==="string"){if(d(this.nodeCheckRule)){this._nodeCheckRule=u(this.nodeCheckRule)}}else{this._nodeCheckRule=this.nodeCheckRule}}async watchDataSetHandler(){this.cleanNodes();await this.watchValueHandler();await this.watchCheckedHandler()}async getNodeById(t){if(!this._items)return null;return this._items.find((e=>c(e,this.fieldId)===t))}async getTreeNode(t){return c(t,this.fieldElement)}async getLabel(t){return c(t,this.fieldLabel)}async unselectAll(){this.value=null}async loadDataSet(){if(this._dataSet)return;if(this.dataSource||this.fetch){try{const t=await this.getDataSource();this.setDataSet(t)}catch(t){console.error("Error loading data:",t)}}else{this.setDataSet(this.dataSet)}}async getSelected(){return this._items.filter((t=>c(t,this.fieldSelected)))}async getSelectedById(){return await this.getSelected().then((t=>t.map((t=>c(t,this.fieldId)))))}async setSearchFocus(){if(this.searchable&&this._searchRef){await this._searchRef.setFocus()}}rerender=w((async()=>{if(!Array.isArray(this._items)||this._items.length===0)return;await Promise.all(this._items.map((async t=>{const e=await this.getTreeNode(t);if(e){n(e)}})));n(this)}),50);renderNode(t){let e=c(t,this.fieldLabel);if(e&&this._searchText){e=l(e,this._searchText)}return i("storm-tree-node",{tree:this,dataSet:t,content:e,searchText:this._searchText})}async setNodeExpanded(t){let e=c(t,this.fieldParent);while(e){const t=await this.getTreeNode(e);if(t){await t.expand().catch((t=>{console.error("Failed to expand tree node:",t)}))}else{o(e,this.fieldExpanded,true)}e=c(e,this.fieldParent)}}cleanNodes(){this._dataSet=undefined;this._items=undefined}async getDataSource(t=null){if(this.fetch){return this.fetch(t?.dataSet)}else{const e=typeof this._dataSource==="function"?this._dataSource(t?.dataSet,this._searchText):this._dataSource;return await v(e)}}async loadChild(t){try{const e=await this.getDataSource(t);const i=this.dataSetParse(e);await this.mergeChild(i,this.fieldChildren.split("&").map((t=>t.trim())));o(t.dataSet,this.fieldChildLoaded,true);this._items=this.updateItems(this._dataSet)}catch(t){console.error("Error loading data:",t)}}async mergeChild(t,e){for(const i of t){const t=await this.getNodeById(c(i,this.fieldId));for(const s of e){const e=c(i,s);const h=c(t,s);if(!!e&&(!h||h.length==0)){o(t,s,e)}else if(!!e&&e.length>0){await this.mergeChild(e,[s])}}}}dataSetParse(t){const e=JSON.parse(JSON.stringify(t));const i=this.structure==="auto"?!Array.isArray(e)&&!!this.fieldChildren?"tree":"array":this.structure;switch(i){case"tree":return c(e,this.fieldChildren);case"array":return e;default:throw new Error(`Unsupported structure type: ${i}`)}}setDataSet(t){if(!t)return;this._dataSet=this.dataSetParse(t);this._items=this.updateItems(this._dataSet);this.rerender()}updateItems(t,e=null){if(!t||t.length===0)return[];const i=[];for(const s of t){let t=c(s,this.fieldId);if(t==null){t=c(s,this.fieldLabel);o(s,this.fieldId,t)}if(this.selection!="none"&&s[this.fieldSelectable]==null){o(s,this.fieldSelectable,f(this,this._nodeSelectableRule,s)??true)}if(this.checkSelectable&&s[this.fieldCheckSelectable]==null){o(s,this.fieldCheckSelectable,f(this,this._nodeCheckRule,s)??true)}let h=1;if(e){o(s,this.fieldParent,e);h=c(e,this.fieldLevel)+1}o(s,this.fieldLevel,h);if(!c(s,this.fieldChildLoaded)){o(s,this.fieldExpanded,this.expandLevel>h);o(s,this.fieldChildLoaded,!this.partialLoad||this.expandLevel>h)}i.push(s);const n=c(s,this.fieldChildren);if(n&&n.length>0){i.push(...this.updateItems(n,s))}}return i}async componentWillLoad(){await g.applyShadowRootStylesAsync(this.host,"material");this.expandIcon=this.expandIcon??(this.expandIconAlign==="right"?"add":"chevron_right");this.collapseIcon=this.collapseIcon??(this.expandIconAlign==="right"?"remove":"expand_more");this.watchDataSourceHandler();this.watchNodeSelectableRuleHandler();this.watchNodeCheckRuleHandler()}async componentWillRender(){if(this.loading==="eager"||!this.partialLoad){await this.loadDataSet()}if(this.selection!="none"&&!this.nullable&&!this.value&&this._items?.length){this.value=c(this._items.find((t=>c(t,this.fieldSelectable))),this.fieldId)}await this.watchValueHandler();await this.watchCheckedHandler()}async componentDidLoad(){if(this._items?.length){this.dateSetLoaded.emit()}}handleSearchChanged(t){t.stopPropagation();const e=t.detail?.trim()??"";if(this._searchText===e)return;if(e){this.searchChanged.emit(e)}}renderSearch(){if(!this.searchable)return;return i(p,{ref:t=>this._searchRef=t,value:this._searchText,onValueChanged:t=>this.handleSearchChanged(t)})}nodesRender(){let t=[];if(this.partialLoad||!this.searchable||this._searchText==null||!this._searchText.length){t=this._dataSet}else{t=this._items.filter((t=>c(t,this.fieldLabel).includes(this._searchText)))}if(t.length===0)return i("div",{class:"align-middle text-center p-4 h6"},"沒有找到符合的結果");return t.map((t=>this.renderNode(t)))}render(){if(!this._dataSet)return;return i(s,null,this.renderSearch(),this.nodesRender())}static get watchers(){return{value:[{watchValueHandler:0}],checked:[{watchCheckedHandler:0}],dataSource:[{watchDataSourceHandler:0}],nodeSelectableRule:[{watchNodeSelectableRuleHandler:0}],nodeCheckRule:[{watchNodeCheckRuleHandler:0}],dataSet:[{watchDataSetHandler:0}]}}};H.style=D();export{b as storm_checkbox,S as storm_tree_node,H as storm_tree_view};
//# sourceMappingURL=p-d4043612.entry.js.map