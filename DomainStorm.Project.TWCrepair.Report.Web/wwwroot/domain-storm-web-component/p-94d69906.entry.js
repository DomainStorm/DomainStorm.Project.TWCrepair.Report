import{r as t,c as e,h as s,H as i,f as h,a}from"./p-CQNG65Br.js";import{p as n,g as r,a as c,s as o,f as l,i as d,b as u,e as m}from"./p-CH__wnBt.js";import{F as p,a as f}from"./p-tR-hyYiS.js";import{d as w}from"./p-9Du3dL5x.js";import{C as k}from"./p-pMD06zDP.js";import{S as g}from"./p-CAnyxfG4.js";import"./p-E-ZsRS8r.js";const y=class{constructor(s){t(this,s),this.valueChanged=e(this,"valueChanged")}_uid;_inputEl;type="checkbox";label;labelClasses="custom-control-label";isDisabled;isChecked;isIndeterminate;isSwitch=!1;isInline=!1;timeStamp;valueChanged;async check(){this.isChecked||(this.isChecked=!0,this.valueChanged.emit(this.isChecked))}async uncheck(){this.isChecked&&(this.isChecked=!1,this.valueChanged.emit(this.isChecked))}renderLabel(){if(this.label)return s("label",{htmlFor:this._uid,class:n(this.labelClasses)},this.label)}componentDidRender(){this._inputEl&&(this._inputEl.indeterminate=!!this.isIndeterminate)}render(){return this._uid||(this._uid=r("storm-checkbox")),s(i,{key:"533ee62f567d7158ec6b46d3988b60ffbbac6134"},s("div",{key:"e3717e9c39a8e883fcef35dae417156baf6c4148",class:{"form-check":!0,"form-check-inline":this.isInline,"form-switch":this.isSwitch}},s("input",{key:"b140fd51708ed36e67e047735a8b740669686273",ref:t=>this._inputEl=t,class:{"form-check-input":!0},id:this._uid,type:this.type,checked:this.isChecked,disabled:this.isDisabled,indeterminate:this.isIndeterminate,onChange:async t=>{t.stopPropagation(),t.target.checked?await this.check():await this.uncheck()}}),this.renderLabel()))}};y.style=":host{display:block}:host>.form-check{padding-left:0.25rem}:host>.form-check.form-switch{padding-left:2.75rem}:host>.form-check.form-switch .form-check-input{margin-top:.3rem}:host>.form-check.form-check-inline{margin-right:.75rem}:host>.form-check:not(.form-switch) .form-check-input[type=checkbox]{margin-top:0}:host .input-group.input-group-static label{margin-left:.25rem;margin-top:.15rem}:host label{cursor:pointer}";const b=class{constructor(s){t(this,s),this.nodeSelect=e(this,"nodeSelect"),this.nodeUnselect=e(this,"nodeUnselect"),this.nodeClick=e(this,"nodeClick"),this.nodeDblClick=e(this,"nodeDblClick"),this.nodeCheck=e(this,"nodeCheck"),this.nodeUncheck=e(this,"nodeUncheck")}_child;href="javascript:void(0);";dataSet;tree;parent;content;searchText;nodeSelect;nodeUnselect;nodeClick;nodeDblClick;nodeCheck;nodeUncheck;async handleNodeClick(t){t.detail===this.getId()&&(this.getSelectable()?this.getSelected()?this.tree.nullable&&await this.unselect():await this.select():(t.stopPropagation(),this.hasChild()&&this.expandToggle()))}expandToggle(){this.getExpanded()?this.collapse():this.expand()}getId(){return c(this.dataSet,this.tree.fieldId)}getHref(){return c(this.dataSet,this.tree.fieldHref)??this.href}getChild(){return c(this.dataSet,this.tree.fieldChildren)||[]}getSelectable(){return c(this.dataSet,this.tree.fieldSelectable)??"none"!=this.tree.selection}getCheckSelectable(){return!0===c(this.dataSet,this.tree.fieldCheckSelectable)}getSelected(){return!0===c(this.dataSet,this.tree.fieldSelected)}getChecked(){return!0===c(this.dataSet,this.tree.fieldChecked)}getDisabled(){return!0===c(this.dataSet,this.tree.fieldDisabled)}setSelected(t){c(this.dataSet,this.tree.fieldSelected)!==t&&(o(this.dataSet,this.tree.fieldSelected,t),this.rerender())}setChecked(t){c(this.dataSet,this.tree.fieldChecked)!==t&&(o(this.dataSet,this.tree.fieldChecked,t),this.rerender())}getExpanded(){return!0===c(this.dataSet,this.tree.fieldExpanded)}async setExpanded(t){this.getExpanded()!==t&&(o(this.dataSet,this.tree.fieldExpanded,t),t&&!c(this.dataSet,this.tree.fieldChildLoaded)&&await this.tree.loadChild(this),this.rerender())}rerender=w((()=>{h(this)}),50);async select(){this.getSelected()||(this.setSelected(!0),this.nodeSelect.emit(this.getId()))}async unselect(){this.getSelected()&&(this.setSelected(!1),this.nodeUnselect.emit(this.getId()))}async check(){this.getChecked()||(this.setChecked(!0),this.nodeCheck.emit(this.getId()))}async uncheck(){this.getChecked()&&(this.setChecked(!1),this.nodeUncheck.emit(this.getId()))}async expand(){await this.setExpanded(!0)}async collapse(){await this.setExpanded(!1)}hasChild(){return!!this.getChild()?.length}renderExpandIcon(){if(!this.searchText)return!this.hasChild()||this.getExpanded()&&""===this.tree.collapseIcon||!this.getExpanded()&&""===this.tree.expandIcon?"left"===this.tree.expandIconAlign?s("span",{class:"indent"}):void 0:s("span",{class:{"mb-1":!0,"mx-1":!0,"position-absolute":"right"===this.tree.expandIconAlign,"end-0":"right"===this.tree.expandIconAlign},onClick:t=>{t.stopPropagation(),this.expandToggle()}},s(p,null,this.getExpanded()?this.tree.collapseIcon:this.tree.expandIcon))}renderIndent(){if(this.searchText)return;const t=[],e=c(this.dataSet,this.tree.fieldLevel);for(let i=1;i<e;i++)t.push(s("span",{class:"indent"}));return this.hasChild()||"left"!==this.tree.expandIconAlign||t.push(s("span",{class:"leaf"})),t}renderChild(){if(!this.searchText&&this.hasChild()&&this.getExpanded())return this._child=this.getChild().map((t=>this.renderNodeItem(t))),s("div",{class:"list-group"},this._child)}renderNodeItem(t){let e=c(t,this.tree.fieldLabel);return e&&this.searchText&&(e=l(e,this.searchText)),s("storm-tree-node",{tree:this.tree,dataSet:t,content:e,searchText:this.searchText})}renderLabel(){return s("span",{innerHTML:this.content})}componentWillLoad(){o(this.dataSet,this.tree.fieldElement,this)}renderCheckbox(){if(this.getCheckSelectable())return s("storm-checkbox",{type:"checkbox",isInline:!0,isChecked:this.getChecked(),onValueChanged:t=>{t.stopPropagation()},onClick:async t=>{t.stopPropagation(),this.tree.selectToCheck?this.nodeClick.emit(this.getId()):this.getChecked()?await this.uncheck():await this.check()}})}render(){if(this.dataSet)return s(i,null,s("a",{href:this.getHref(),class:{"py-1":!0,"px-1":!0,"list-group-item":!0,"list-group-item-action":c(this.dataSet,this.tree.fieldSelectable),"list-group-item-primary":"primary"==this.tree.color,"list-group-item-secondary":"secondary"==this.tree.color,"list-group-item-success":"success"==this.tree.color,"list-group-item-danger":"danger"==this.tree.color,"list-group-item-warning":"warning"==this.tree.color,"list-group-item-info":"info"==this.tree.color,"list-group-item-light":"light"==this.tree.color,"list-group-item-dark":"dark"==this.tree.color,"d-flex":!0,"align-items-end":!0,active:this.getSelected(),disabled:this.getDisabled()},onClick:t=>{t.stopPropagation(),this.nodeClick.emit(this.getId())},onDblClick:t=>{t.stopPropagation(),this.nodeDblClick.emit(this.getId())}},this.renderIndent(),this.renderExpandIcon(),s(p,null,c(this.dataSet,this.tree.fieldIcon)),this.renderCheckbox(),this.renderLabel()),this.renderChild())}disconnectedCallback(){o(this.dataSet,this.tree.fieldElement,void 0)}};b.style=':host{display:block;-webkit-user-select:none;user-select:none}.list-group-item.active .form-check:not(.form-switch) .form-check-input[type="checkbox"]:checked{background:#fff !important;border-color:#fff !important}.list-group-item.active .form-check:not(.form-switch) .form-check-input[type="checkbox"]::after{color:#e91e63 !important}.list-group-item .form-check{margin-bottom:0 !important}';const C=new k(new class{dbPromise=null;maxEntries;dbName;dbVersion;constructor(t=1e3,e="StencilCacheDB",s=1){this.maxEntries=Math.max(1,t),this.dbName=e,this.dbVersion=s}openDB(){return this.dbPromise||(this.dbPromise=new Promise(((t,e)=>{const s=window.indexedDB.open(this.dbName,this.dbVersion);s.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains("cache")||e.createObjectStore("cache",{keyPath:"key"}).createIndex("timestamp","timestamp",{unique:!1})},s.onsuccess=e=>{t(e.target.result)},s.onerror=()=>{this.dbPromise=null,e(s.error)}}))),this.dbPromise}async withTransaction(t,e){const s=(await this.openDB()).transaction("cache",t);return await e(s.objectStore("cache"))}async get(t){return await this.withTransaction("readonly",(e=>new Promise(((s,i)=>{const h=e.get(t);h.onsuccess=()=>{const t=h.result;s(t?{value:t.value,timestamp:t.timestamp,ttlMillis:t.ttlMillis}:null)},h.onerror=()=>i(h.error)}))))}async set(t,e){await this.withTransaction("readwrite",(s=>new Promise(((i,h)=>{const a=s.get(t);a.onsuccess=()=>{const n=()=>{const a=s.put({key:t,...e});a.onsuccess=()=>i(),a.onerror=()=>h(a.error)};if(a.result)n();else{const t=s.count();t.onsuccess=()=>{t.result>=this.maxEntries?this.evictOldestEntry(s,n,h):n()},t.onerror=()=>h(t.error)}},a.onerror=()=>h(a.error)}))))}evictOldestEntry(t,e,s){const i=t.index("timestamp").openCursor();i.onsuccess=t=>{const i=t.target.result;if(i){const t=i.delete();t.onsuccess=e,t.onerror=()=>s(t.error)}else e()},i.onerror=()=>s(i.error)}async delete(t){await this.withTransaction("readwrite",(e=>new Promise(((s,i)=>{const h=e.delete(t);h.onsuccess=()=>s(),h.onerror=()=>i(h.error)}))))}async clear(){await this.withTransaction("readwrite",(t=>new Promise(((e,s)=>{const i=t.clear();i.onsuccess=()=>e(),i.onerror=()=>s(i.error)}))))}get defaultKeyPrefix(){return"idb"}async size(){return await this.withTransaction("readonly",(t=>new Promise(((e,s)=>{const i=t.count();i.onsuccess=()=>e(i.result),i.onerror=()=>s(i.error)}))))}setMaxEntries(t){this.maxEntries=Math.max(1,t)}getMaxEntries(){return this.maxEntries}async destroy(){return this.dbPromise&&((await this.dbPromise).close(),this.dbPromise=null),new Promise(((t,e)=>{const s=window.indexedDB.deleteDatabase(this.dbName);s.onsuccess=()=>t(),s.onerror=()=>e(s.error),s.onblocked=()=>{console.warn("Database deletion blocked. Other connections may be open."),t()}}))}},{regionName:"fetchDataSource"}),S=class{constructor(s){t(this,s),this.dataSetLoaded=e(this,"dataSetLoaded"),this.valueChanged=e(this,"valueChanged"),this.nodeSelect=e(this,"nodeSelect"),this.nodeUnselect=e(this,"nodeUnselect"),this.nodeClick=e(this,"nodeClick"),this.nodeDblClick=e(this,"nodeDblClick"),this.nodeCheck=e(this,"nodeCheck"),this.nodeUncheck=e(this,"nodeUncheck"),this.checkedChanged=e(this,"checkedChanged"),this.searchChanged=e(this,"searchChanged")}_searchText;_dataSet;_items;_dataSource;_searchRef;_nodeSelectableRule;_nodeCheckRule;get host(){return a(this)}partialLoad=!1;loading="eager";value;checked=[];fieldId="id";fieldLabel="label";fieldChildren="children";fieldSubId="subId";fieldSubLabel="subLabel";fieldSubChildren="subChildren";fieldSelected="_selected";fieldChecked="_checked";fieldExpanded="_expanded";fieldDisabled="_disabled";fieldParent="_parent";fieldSelectable="_selectable";fieldCheckSelectable="_checkSelectable";fieldIcon="_icon";fieldHref="_href";fieldLevel="_level";fieldChildLoaded="_loaded";fieldElement="_element";expandIconAlign="left";expandIcon;collapseIcon;color;dataSet;dataSource;fetch;nullable=!0;expandLevel=2;structure="auto";searchable=!1;selection="single";nodeSelectableRule;checkSelectable=!1;nodeCheckRule;selectToCheck=!0;dataSetLoaded;valueChanged;nodeSelect;nodeUnselect;nodeClick;nodeDblClick;nodeCheck;nodeUncheck;checkedChanged;searchChanged;async searchChangedHandler(t){this._searchText=t.detail,this.partialLoad?(this.cleanNodes(),await this.loadDataSet()):this.rerender()}nodeSelectHandler(t){switch(this.selection){case"single":this.value=t.detail;break;case"multiple":{const e=Array.isArray(this.value)?this.value:this.value?[this.value]:[];e.includes(t.detail)||(this.value=[...e,t.detail]);break}default:console.warn(`Unknown selection mode: ${this.selection}`)}}nodeUnselectHandler(t){switch(this.selection){case"single":this.value===t.detail&&(this.value=null);break;case"multiple":{const e=Array.isArray(this.value)?this.value:[];e.includes(t.detail)&&(this.value=e.filter((e=>e!==t.detail)));break}default:console.warn(`Unknown selection mode: ${this.selection}`)}}nodeCheckHandler(t){this.selectToCheck||this.checked.includes(t.detail)||(this.checked=[...this.checked,t.detail])}nodeUncheckHandler(t){this.selectToCheck||this.checked.includes(t.detail)&&(this.checked=this.checked.filter((e=>e!==t.detail)))}async valueChangedHandler(){if(!Array.isArray(this._items))return;const t=Array.isArray(this.value)?this.value:this.value?[this.value]:[];await Promise.all(this._items.map((async e=>{const s=String(c(e,this.fieldId)),i=t.includes(s),h=!0===c(e,this.fieldSelected),a=[];return i&&a.push(this.setNodeExpanded(e)),h!==i&&a.push(this.setNodeSelectionState(e,i)),Promise.all(a)}))),this.checkSelectable&&this.selectToCheck&&(this.checked=t)}async checkedChangedHandler(){Array.isArray(this._items)&&await Promise.all(this._items.map((t=>{const e=String(c(t,this.fieldId)),s=(Array.isArray(this.checked)?this.checked:this.checked?[this.checked]:[]).includes(e);return!0===c(t,this.fieldChecked)!==s?this.setNodeCheckedState(t,s):Promise.resolve()})))}async watchValueHandler(){this.valueChanged.emit(this.value)}async watchCheckedHandler(){this.checkedChanged.emit(this.checked)}async setNodeSelectionState(t,e){const s=await this.getTreeNode(t);s?await(e?s.select():s.unselect()):o(t,this.fieldSelected,e),this.checkSelectable&&this.selectToCheck&&await this.setNodeCheckedState(t,e)}async setNodeCheckedState(t,e){const s=await this.getTreeNode(t);s?await(e?s.check():s.uncheck()):o(t,this.fieldChecked,e)}watchDataSourceHandler(){this.cleanNodes(),this._dataSource="string"==typeof this.dataSource?d(this.dataSource)?u(this.dataSource):this.dataSource.startsWith("{")&&this.dataSource.endsWith("}")?JSON.parse(this.dataSource):{url:this.dataSource}:this.dataSource}watchNodeSelectableRuleHandler(){"string"==typeof this.nodeSelectableRule?d(this.nodeSelectableRule)&&(this._nodeSelectableRule=u(this.nodeSelectableRule)):this._nodeSelectableRule=this.nodeSelectableRule}watchNodeCheckRuleHandler(){"string"==typeof this.nodeCheckRule?d(this.nodeCheckRule)&&(this._nodeCheckRule=u(this.nodeCheckRule)):this._nodeCheckRule=this.nodeCheckRule}async watchDataSetHandler(){this.cleanNodes(),await this.watchValueHandler(),await this.watchCheckedHandler()}async getNodeById(t){return this._items?this._items.find((e=>c(e,this.fieldId)===t)):null}async getTreeNode(t){return c(t,this.fieldElement)}async getLabel(t){return c(t,this.fieldLabel)}async unselectAll(){this.value=null}async loadDataSet(){if(!this._dataSet)if(this.dataSource||this.fetch)try{const t=await this.getDataSource();this.setDataSet(t)}catch(t){console.error("Error loading data:",t)}else this.setDataSet(this.dataSet)}async getSelected(){return this._items?.filter((t=>c(t,this.fieldSelected)))??[]}async getSelectedById(){return await this.getSelected().then((t=>t.map((t=>c(t,this.fieldId)))))}async setSearchFocus(){this.searchable&&this._searchRef&&await this._searchRef.setFocus()}rerender=w((async()=>{Array.isArray(this._items)&&0!==this._items.length&&(await Promise.all(this._items.map((async t=>{const e=await this.getTreeNode(t);e&&h(e)}))),h(this))}),50);renderNode(t){let e=c(t,this.fieldLabel);return e&&this._searchText&&(e=l(e,this._searchText)),s("storm-tree-node",{tree:this,dataSet:t,content:e,searchText:this._searchText})}async setNodeExpanded(t){let e=c(t,this.fieldParent);for(;e;){const t=await this.getTreeNode(e);t?await t.expand().catch((t=>{console.error("Failed to expand tree node:",t)})):o(e,this.fieldExpanded,!0),e=c(e,this.fieldParent)}}cleanNodes(){this._dataSet=void 0,this._items=void 0}async getDataSource(t=null){if(this.fetch)return this.fetch(t?.dataSet);{const e="function"==typeof this._dataSource?this._dataSource(t?.dataSet,this._searchText):this._dataSource;return await async function(t){t={method:"POST",contentType:"application/json",...t};const e=JSON.stringify(t),s=await C.get(e);if(null!==s)return s;const i=await fetch(t.url,{method:t.method,body:"GET"!==t.method?JSON.stringify(t.body??{}):null,headers:new Headers({"Content-Type":t.contentType})});if(!i.ok)throw new Error(`Network response was not ok: ${i.statusText}`);const h="application/json"===t.contentType?await i.json():await i.text();return await C.set(e,h),h}(e)}}async loadChild(t){try{const e=await this.getDataSource(t),s=this.dataSetParse(e);await this.mergeChild(s,this.fieldChildren.split("&").map((t=>t.trim()))),o(t.dataSet,this.fieldChildLoaded,!0),this._items=this.updateItems(this._dataSet)}catch(t){console.error("Error loading data:",t)}}async mergeChild(t,e){for(const s of t){const t=await this.getNodeById(c(s,this.fieldId));for(const i of e){const e=c(s,i),h=c(t,i);!e||h&&0!=h.length?e&&e.length>0&&await this.mergeChild(e,[i]):o(t,i,e)}}}dataSetParse(t){const e=JSON.parse(JSON.stringify(t)),s="auto"===this.structure?!Array.isArray(e)&&this.fieldChildren?"tree":"array":this.structure;switch(s){case"tree":return c(e,this.fieldChildren);case"array":return e;default:throw new Error(`Unsupported structure type: ${s}`)}}setDataSet(t){t&&(this._dataSet=this.dataSetParse(t),this._items=this.updateItems(this._dataSet),this.rerender())}updateItems(t,e=null){if(!t||0===t.length)return[];const s=[];for(const i of t){let t=c(i,this.fieldId);null==t&&(t=c(i,this.fieldLabel),o(i,this.fieldId,t)),"none"!=this.selection&&null==i[this.fieldSelectable]&&o(i,this.fieldSelectable,m(this,this._nodeSelectableRule,i)??!0),this.checkSelectable&&null==i[this.fieldCheckSelectable]&&o(i,this.fieldCheckSelectable,m(this,this._nodeCheckRule,i)??!0);let h=1;e&&(o(i,this.fieldParent,e),h=c(e,this.fieldLevel)+1),o(i,this.fieldLevel,h),c(i,this.fieldChildLoaded)||(o(i,this.fieldExpanded,this.expandLevel>h),o(i,this.fieldChildLoaded,!this.partialLoad||this.expandLevel>h)),s.push(i);const a=c(i,this.fieldChildren);a&&a.length>0&&s.push(...this.updateItems(a,i))}return s}async componentWillLoad(){await g.applyShadowRootStylesAsync(this.host,"material"),this.expandIcon=this.expandIcon??("right"===this.expandIconAlign?"add":"chevron_right"),this.collapseIcon=this.collapseIcon??("right"===this.expandIconAlign?"remove":"expand_more"),this.watchDataSourceHandler(),this.watchNodeSelectableRuleHandler(),this.watchNodeCheckRuleHandler()}async componentWillRender(){"eager"!==this.loading&&this.partialLoad||await this.loadDataSet(),"none"==this.selection||this.nullable||this.value||!this._items?.length||(this.value=c(this._items.find((t=>c(t,this.fieldSelectable))),this.fieldId)),await this.watchValueHandler(),await this.watchCheckedHandler()}async componentDidLoad(){this._items?.length&&this.dataSetLoaded.emit()}handleSearchChanged(t){t.stopPropagation();const e=t.detail?.trim()??"";this._searchText!==e&&e&&this.searchChanged.emit(e)}renderSearch(){if(this.searchable)return s(f,{ref:t=>this._searchRef=t,value:this._searchText,onValueChanged:t=>this.handleSearchChanged(t)})}nodesRender(){let t=[];return t=!this.partialLoad&&this.searchable&&null!=this._searchText&&this._searchText.length?this._items?.filter((t=>c(t,this.fieldLabel)?.includes(this._searchText)))??[]:this._dataSet,0===t.length?s("div",{class:"align-middle text-center p-4 h6"},"沒有找到符合的結果"):t.map((t=>this.renderNode(t)))}render(){if(this._dataSet)return s(i,null,this.renderSearch(),this.nodesRender())}static get watchers(){return{value:[{watchValueHandler:0}],checked:[{watchCheckedHandler:0}],dataSource:[{watchDataSourceHandler:0}],nodeSelectableRule:[{watchNodeSelectableRuleHandler:0}],nodeCheckRule:[{watchNodeCheckRuleHandler:0}],dataSet:[{watchDataSetHandler:0}]}}};S.style=":host{display:block;background-color:#fff}:host .list-group-item{border:none !important;white-space:nowrap !important;cursor:pointer !important;margin-bottom:0 !important}:host .close.material-icons,:host .open.material-icons:hover{opacity:0.5}:host .open.material-icons,:host .close.material-icons:hover{opacity:1}:host .material-icons:empty{width:1.25rem}:host .indent{margin-left:0.575rem;margin-right:0.575rem}:host .leaf{margin-left:0.6rem}";export{y as storm_checkbox,b as storm_tree_node,S as storm_tree_view}